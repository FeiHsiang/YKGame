<!doctype html>
<html >
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>upload sky</title>
	<style>

		html, body {
			overflow: hidden;
			background: #fff;
			color: #000;
			font-family: sans-serif;
			text-align: center;
			width:100vw;
			height:100vh;
			margin: 0;
		}

		#aDiv{
			/* margin: 20px 10px; */
			/* width:800px; */
			/* height:600px; */
			position: relative;
			width:100vw;
			height:100vh;
		}

		@media screen and (min-width: 300px) and (max-width: 700px) {
			#aDiv{
				/* margin: 20px 10px; */
				/* width:400px; */
				/* height:300px; */
				position: relative;
				width:100vw;
				height:100vh;
			}
		}

		#blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1;
			display: none;
        }

		.modal {
			display: none; /* Hidden by default */
			position: fixed; /* Stay in place */
			z-index: 1; /* Sit on top */
			left: 0;
			top: 0;
			/* https://stackoverflow.com/questions/10075524/sizing-div-based-on-window-width/35237091#35237091 */
			width: 100vw; /* Full width */
			height: 100vh; /* Full height */
			background-color: rgba( 74 , 77 , 84 , 0.85 ); /* Black w/ opacity */
		}

		/* Modal Content/Box */
		.modal-content {
			position: relative;
			background-color: #202125;
			margin: auto;
			top: 5%;
			border-radius: 16px;
			width: 85vw;
			height: 75vh;
			overflow: auto;
		}

		.modal-content > div {
			position: relative;
			margin-left: 2%;
			margin-right: 2%;
			width: 90%;
			color:white;
			text-align: left;
			font-size: 20pt;
		}


		.centerText {
			margin: 0;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			white-space:nowrap;
		}
		
		/* 結算畫面  ----------------------- start ---------------------------  */

		#blocker_score {
			display: none;
			position: absolute;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.7);
			z-index: 1;
		}

		#previousCoins{
			margin-top: 40px;
		}

		#getCoins{
			margin-top: 20px;
		}

		#currentCoins{
			margin-top: 20px;
		}

		#score_info{
			right:-40%;
			width:50%;
			height:auto;
			font-size:18px; 
			color:#00c99c;
			border: 2px solid white;
			padding:10px;
		}

		#leaderBn , #leaveConfirm {
			position:absolute;
			bottom: 15px;
			left:3px;
			width:40%;
			height:20%;
			max-height: 50px;
			border-radius: 20px;
			background-color: rgba(80, 160, 150, 1.0);
			cursor: pointer;
		}

		#couponPage, #leaveCancel{
			position:absolute;
			bottom: 15px;
			right:3px;
			width:40%;
			height:20%;
			max-height: 50px;
			border-radius: 20px;
			background-color: rgba(80, 110, 150, 1.0);
			cursor: pointer;
		}

		/* 結算畫面  ----------------------- end ---------------------------  */

		/* 排行榜    ----------------------- start --------------------------- */

		#leadBnTitle{
			position: relative;
			margin-top: 15px;
			margin-bottom: 30px;
			min-height: 30px;
			text-align: center;
		}

		#leadBnImg{
			position: absolute;
			width:60px;
			height:60px;
			left:5px ;
		}

		#leadBnInfo{
			position: relative;
			font-size: 30px;
			color: #afb4f9;
			left: 32px ;
			top:15px;
		}

		#leaderTable{
			margin: auto;
			width:90%;
			color:white;
			font-size:14pt;
			overflow-wrap:anywhere;
		}

		#closeLeadBnModal{
			color: rgba(20,20,20,1.0);
			background-color: rgba(200,200,200,1.0);
			position: absolute;
			bottom: 10px;
			width: 40%;
			height:30px;
			left:30%;
			font-size: 18px;
			cursor: pointer;
		}

		/* 排行榜    ----------------------- end --------------------------- */

		/* 離開警告  ----------------------- start --------------------------- */

		#warningInfo{
			text-align: center;
			top: 40%;
		}
 
		/* 離開警告  ----------------------- end --------------------------- */

		#score{
			position: absolute;
			z-index: 2;
			left :5%;
			bottom: 2%;		
			font-family: Arial;
			font-size: 20px;
			/* color: #FFFFFF; */
		}

		#ballAmount{
			position: absolute;
			z-index: 2;
			right :5%;
			bottom: 2%;		
			font-family: Arial;
			font-size: 20px;
			/* color: #FF0000; */
		}

		#leaveButton{
			position: absolute;
			z-index: 2;
			font-size: 15pt;
			color:rgba(0,0,0,0.9);
			background-color:rgba(220,220,220,1.0);
			padding: 5px;
			cursor:pointer;
		}

	</style>


</head>
<body>
	<!-- <script src = "/scripts/main.js"></script> -->
	<div id = "leaveButton">
		回遊戲首頁
	</div>

	<div id="blocker">
        <div class="instructions" id = "blocker_info">
            <span style="font-size:36px">Click to play</span>
            <br /><br />
            滑鼠/手指滑動螢幕來丟球<br/>
            總共12球，看看你能夠得到幾分吧<br/>
        </div>
	</div>
	
	<div id="blocker_score" class="modal">
		<div class="modal-content">
			<div id = "previousCoins">原有代幣：</div>
			<div id = "getCoins">新增代幣：</div>
			<hr>
			<div id = "currentCoins">結算代幣：</div>
			<div id = "score_info"> </div>
			<div id = "leaderBn"> <div class="centerText">排行榜</div></div>
			<div id = "couponPage" > <div class="centerText">去兌換</div></div>
		</div>
	</div>

	<div id="leadBnModal" class="modal">
        <div class="modal-content">
			<div id="leadBnTitle">
				<img id="leadBnImg" src="/images/crown.png">
				<span id="leadBnInfo">永康幣排行榜</span>
			</div>
			<table id = "leaderTable" ></table>

			<div id="closeLeadBnModal" >
				<p  class = "centerText" >關閉</p> 
			</div>
		  
        </div>
	</div>
	
	<div id="leaveWarning" class="modal">
		<div class="modal-content">
			
			<div id = "warningInfo"> 確認回到遊戲首頁嘛？ </div>


			<div id = "leaveConfirm"> <div class="centerText">確認</div></div>
			<div id = "leaveCancel" > <div class="centerText">取消</div></div>

		</div>
	</div>



	<div id="score">
		分數: 0
	</div>

	<div id="ballAmount">
		球數: 12
	</div>


	<script src="js/vconsole.min.js"></script>
	<script>
		if ( window.navigator.userAgent.toLowerCase().indexOf("mobile") >= 0 && window.navigator.userAgent.toLowerCase().indexOf("chrome") < 0 ){
			var vConsole = new VConsole();
			console.log("The system is mobile: ", window.navigator.userAgent.toLowerCase() );
		}else{
			console.log("The system is PC: ", window.navigator.userAgent.toLowerCase() );
		}

		window.requestDeviceMotionPermission = function (){
            // console.log("makarVR.html: requestDeviceMotionPermission  " );
            if (typeof(DeviceMotionEvent) !== 'undefined' && typeof(DeviceMotionEvent.requestPermission) === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    console.log("makarVR.html: requestPermission response =", response );
                    // alert('Orientation tracking '+ response);
                    if (response == 'granted') {
                        window.addEventListener('devicemotion', (e) => {
                            // but.style.visibility='hidden';
                        })
                    }
                }).catch(console.error)
            }else {
                // alert('DeviceMotionEvent is not defined');
                // console.log("makarVR.html: requestPermission: DeviceMotionEvent is not defined " );
            }
		}

		document.body.onclick = function(){
			requestDeviceMotionPermission();
		}

		document.getElementById("leaveButton").addEventListener('click', function(){
			
			if (blocker_score.style.display == "block"){
				location.replace("/games");
			}else{
				leaveWarning.style.display = "block";
				leaveConfirm.onclick = function(){
					location.replace("/games");
				}
				leaveCancel.onclick = function(){
					leaveWarning.style.display = "none";
				}
			}

		});

	</script>

	<script src="js/aframe-v1.0.4.js"></script>
	<script src="js/aframe-extras.js"></script>

	<script src="js/aframe-physics-system.js"></script>

	<!-- <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script> -->

	<div id = "aDiv"  >
		<a-scene id = "aScene" embedded="" vr-mode-ui="enabled: false" 
		device-orientation-permission-ui="enabled: true"  shadow="type: pcfsoft"
		physics="debug: false; friction: 0.005; " >
			<a-assets id = "aAssets">

				<a-asset-item id="baseball" src="model/baseball.glb"></a-asset-item>
				<!-- <a-asset-item id="baseballShelf" src="model/baseballShelf.glb"></a-asset-item> -->
				<a-asset-item id="baseballShelf" src="model/baseballShelf2.glb"></a-asset-item>

				<img id="n1" src="images/n1.png">
				<img id="n2" src="images/n2.png">
				<img id="n3" src="images/n3.png">
				<img id="n4" src="images/n4.png">
				<img id="n5" src="images/n5.png">
				<img id="n6" src="images/n6.png">
				<img id="n7" src="images/n7.png">
				<img id="n8" src="images/n8.png">
				<img id="n9" src="images/n9.png">

			</a-assets>

			<a-entity id="rig" position="0.0 0.8 3" rotation="0 0 0">
				<!-- <a-entity id="aCamera" camera  look-controls wasd-controls></a-entity> -->
				<!-- <a-entity id="aCamera" camera="fov:80; zoom:1" > -->
				<a-entity id="aCamera" camera  look-controls="touchEnabled:false" wasd-controls>
					<!-- 棒球本身 -->
					<a-entity visible = "true" id = "aSphere" position="0 -0.8 -1.5" rotation="0 0 0" scale=" 0.3 0.3 0.3 " gltf-model="#baseball" ></a-entity>

				</a-entity>
			</a-entity>
			
			<!-- 棒球本身 -->
			<!-- <a-entity visible = "true" id = "aSphere" position="0 -0.0 1.5" rotation="0 0 0" scale=" 0.3 0.3 0.3 " gltf-model="#baseball" ></a-entity> -->


			<!-- 棒球九宮格 -->

			<!-- 架子 -->
			<a-entity visible = "true" id = "shelf" position="0 -2 -3" rotation="0 0 0" scale="2 2 2" gltf-model="#baseballShelf" ></a-entity>

			<!-- 框 -->

			<a-box id = "frame1" width="3.1" height="0.05" depth="0.05" position="-0.525 1.55 -3" rotation="0 0 90" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<a-box id = "frame2" width="3.1" height="0.05" depth="0.05" position="0.525 1.55 -3" rotation="0 0 90" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<a-box id = "frame3" width="3.1" height="0.05" depth="0.05" position="-1.575 1.55 -3" rotation="0 0 90" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<a-box id = "frame4" width="3.1" height="0.05" depth="0.05" position="1.575 1.55 -3" rotation="0 0 90" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<a-box id = "frame5" width="3.2" height="0.05" depth="0.05" position="0 1.025 -3" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<a-box id = "frame6" width="3.2" height="0.05" depth="0.05" position="0 2.075 -3" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<a-box id = "frame7" width="3.2" height="0.05" depth="0.05" position="0 3.125 -3" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<a-box id = "frame8" width="3.2" height="0.05" depth="0.05" position="0 -0.025 -3" static-body visible="true" color="#f8e096" material="shader: flat;"></a-box>

			<!-- 板子 -->

			<a-plane  position="-1.05 2.575 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board1" 
			shadow="receive: true" material="shader: flat; src: #n1;" ></a-plane>

			<a-plane  position="0 2.575 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board2" 
			shadow="receive: true" material="shader: flat; src: #n2;" ></a-plane>

			<a-plane  position="1.05 2.575 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board3" 
			shadow="receive: true" material="shader: flat; src: #n3;" ></a-plane>

			<a-plane  position="-1.05 1.55 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board4" 
			shadow="receive: true" material="shader: flat; src: #n4;"  ></a-plane>

			<a-plane  position="0 1.55 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board5" 
			shadow="receive: true" material="shader: flat; src: #n5;"  ></a-plane>

			<a-plane  position="1.05 1.55 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board6" 
			shadow="receive: true" material="shader: flat; src: #n6;"  ></a-plane>			
			
			<a-plane  position="-1.05 0.5 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board7" 
			shadow="receive: true" material="shader: flat; src: #n7;" ></a-plane>

			<a-plane  position="0 0.5 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board8" 
			shadow="receive: true" material="shader: flat; src: #n8;" ></a-plane>

			<a-plane  position="1.05 0.5 -3" rotation="0 0 0" width="1" height="1" opacity="1.0" side="double" id ="board9" 
			shadow="receive: true" material="shader: flat; src: #n9;" ></a-plane>





			<!-- 棒球九宮格 -->

			<a-plane id="underplane" position="0 -3 0" rotation="-90 0 0" width="50" height="50" color="#7BC8A4" opacity="0.8" shadow="receive: true" static-body></a-plane>

			<!-- <a-sky id = "aSky" color="#ECECEC"></a-sky> -->
			<a-entity light="type: ambient; color: #FFFFFF; intensity: 1.0"></a-entity>
			<a-entity light="type: directional; color: #FFFFFF; intensity: 0.3;
								   castShadow: true; 
								   shadowCameraVisible: false;
								   shadowBias:-0.0005; 
								   shadowCameraTop:10; shadowCameraBottom:-10; 
								   shadowCameraRight:10; shadowCameraLeft:-10; 
								   shadowMapHeight:3072; shadowMapWidth:3072; 
								   shadowCameraFar: 500; shadowCameraNear: 0.5;" 
			          position="0 0 1"></a-entity>
			<!-- <a-entity camera="active: true" look-controls wasd-controls position="0 1.6 0"></a-entity> -->
		</a-scene>

	</div>	

	<script>


		board1.setAttribute("dynamic-body", "mass:500");
		board2.setAttribute("dynamic-body", "mass:500");
		board3.setAttribute("dynamic-body", "mass:500");
		board4.setAttribute("dynamic-body", "mass:500");
		board5.setAttribute("dynamic-body", "mass:500");
		board6.setAttribute("dynamic-body", "mass:500");
		board7.setAttribute("dynamic-body", "mass:500");
		board8.setAttribute("dynamic-body", "mass:500");
		board9.setAttribute("dynamic-body", "mass:500");



		blocker.addEventListener("click", function(){
			blocker.style.display = "none";
		});


		aCamera.addEventListener('loaded', function(evt) { 
			if (window.navigator.userAgent.toLowerCase().indexOf("mobile") < 0){
				console.log(" PC, remove look wasd control ");
				aCamera.removeAttribute("look-controls");
				aCamera.removeAttribute("wasd-controls");
			}else{
				// pivotGun.setAttribute("visible", "false");
			}
		});

		//// 設定場景功能，分為 
		//// 1. 按住滑鼠/觸控 來拖拉物件，不可拖拉出特定圓圈範圍。
		//// 2. 放開滑鼠/觸控 來拋射物件，依照移動參數來設定拋射參數。
		//// 3. 設定拋射物件的後續狀況。
		////

		let aScene = document.getElementById("aScene");
		let aRig =  document.getElementById("rig"); //// 原始位置為 (0, 1.6, 0)
		let aSphere =  document.getElementById("aSphere"); //// 原始位置為 (0, 1, -1)
		let aRobot = document.getElementById("aRobot");
		let underplane = document.getElementById("underplane");
		let scoreText = document.getElementById("score")
		let ballAmountText = document.getElementById("ballAmount")
		let aSphereOriginPosition = aSphere.object3D.position.clone();
		// let aSphereOriginPosition = new THREE.Vector3();
		aSphere.addEventListener("object3dset" , function(evt){
			// aSphereOriginPosition = aSphere.object3D.getWorldPosition(new THREE.Vector3());
			aSphereOriginPosition = aSphere.object3D.position.clone();
			console.log("3 aSphereOriginPosition = " , aSphereOriginPosition );
		});

		//// 處理架子材質，無光標準
		shelf.addEventListener('model-loaded', function(evt){
			evt.detail.model;
			let objj = shelf.getObject3D('mesh');
			objj.traverse(node => {
				if (node.isMesh) {
					node.material = new THREE.MeshBasicMaterial({color: new THREE.Color(1,1,1), name: node.name, skinning: node.material.skinning, map: node.material.map});
					if (node.material.map){
						node.material.map.encoding = THREE.GammaEncoding;
						node.material.map.needsUpdate = true;
					}
					node.material.needsUpdate = true;
				}
			});
		});
		//// 處理球的材質，無光標準
		aSphere.addEventListener('model-loaded', function(evt){
			evt.detail.model;
			let objj = aSphere.getObject3D('mesh');
			objj.traverse(node => {
				if (node.isMesh) {
					node.material = new THREE.MeshBasicMaterial({color: new THREE.Color(1,1,1), name: node.name, skinning: node.material.skinning, map: node.material.map});
					if (node.material.map){
						node.material.map.encoding = THREE.GammaEncoding;
						node.material.map.needsUpdate = true;
					}
					node.material.needsUpdate = true;
				}
			});
		});

		
		// let ball = document.getElementById("ball");

		let preMouse = new THREE.Vector2();
		let mouse = new THREE.Vector2();
		let mouseStart = new THREE.Vector2();
		let mouseEnd = new THREE.Vector2();
		let pdiff = new THREE.Vector2();
		let raycaster = new THREE.Raycaster();

		let touchMoveTime = Date.now();
		//// 預設原始固定長度為 3 的array 來紀錄滑鼠或觸碰的y值，
		let preMouses = [[0,0],[0,0],[0,0],[0,0]];
		
		//// 機器人物件遭遇碰撞後的反應，切換動畫。
		// aRobot.addEventListener('collide', function(e){
		// 	console.log('Player has collided with body #', e.detail.target.el.object3D );
		// 	aRobot.setAttribute("animation-mixer" , "clip: Death");
		// 	setTimeout(function(){
		// 		aRobot.setAttribute("animation-mixer" , "clip: Walking");
		// 	}, 1000);
		// });
		let boardTable = [0,0,0,0,0,0,0,0,0];
		let ballAmount = 12;
		let score = 0;
		// 下方平面被撞到 算分並重置
		// underplane.addEventListener('collide', function(e){
		// 	if (e.detail.contact.bj.el.id == "underplane"){
		// 		// console.log(e.detail.contact.bi.el.id )
		// 		boardNum = e.detail.contact.bi.el.id[5]-1;
		// 		if(boardTable[boardNum]==0){
		// 			boardTable[boardNum] = 1;
		// 			score += 1
		// 			// console.log(score)
		// 			scoreText.innerText = "分數: "+score.toString();
		// 		}
		// 	}
		// 	// console.log('score',e.detail)
		// 	// console.log('plane is hit', e.detail.target.el.object3D );

		// });

		board1.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board1"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[0]==0){
					boardTable[0] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board2.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board2"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[1]==0){
					boardTable[1] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board3.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board3"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[2]==0){
					boardTable[2] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board4.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board4"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[3]==0){
					boardTable[3] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board5.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board5"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[4]==0){
					boardTable[4] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board6.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board6"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[5]==0){
					boardTable[5] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board7.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board7"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[6]==0){
					boardTable[6] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board8.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board8"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[7]==0){
					boardTable[7] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		board9.addEventListener('collide', function(e){
			if (e.detail.contact.bi.el.id == "board9"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bi.el.object3D.position
				if(pos.y < 0 && boardTable[8]==0){
					boardTable[8] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});


		

		document.body.addEventListener("mouseup", clearTouchState, false);
		document.body.addEventListener("touchend", clearTouchState, false);

		aScene.canvas.addEventListener("touchstart", vrSceneTouchStart, false);
		aScene.canvas.addEventListener("mousedown", vrSceneTouchStart, false);

		aScene.canvas.addEventListener("mousemove", vrSceneTouchMove, false);
		aScene.canvas.addEventListener("touchmove", vrSceneTouchMove, false);

		aScene.canvas.addEventListener("mouseup", vrSceneTouchEnd, false);
		aScene.canvas.addEventListener("touchend", vrSceneTouchEnd, false);

		let touchState = 0; //// 0: 滑鼠沒有按下/手指沒有點擊, 1: 滑鼠已經按下/手指正在點擊, 2: 滑鼠剛剛放開/手指剛剛離開，注意 0 - 2 狀態轉移
		function vrSceneTouchStart(event){

			if (touchState == 0){
				touchState = 1;
				event.preventDefault();

				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mousedown": ////// 20190709 Fei: add this event type for PC mouse
						mouseStart.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseStart.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;
					case "touchstart": ////// 20190709 Fei: add this event type for cellphone
						// console.log("endEvent: touchend: event.touches  = ", event.changedTouches[0].clientX, event.changedTouches[0].clientY );
						mouseStart.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseStart.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousedown/touchstart, return ");
						return ;

				}

				//// 點擊即把球物件移動到滑鼠/觸碰位置 
				// let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs(aRig.object3D.position.z - aSphereOriginPosition.z) * 1 ;
				let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs( aSphere.object3D.position.z ) * 1 ;
				let planeWidth = planeHeight * aCamera.object3DMap.camera.aspect;
				aSphere.object3D.position.x = mouseStart.x * planeWidth ;
				// aSphere.object3D.position.y = aRig.object3D.position.y + mouseStart.y * planeHeight ;
				aSphere.object3D.position.y = aRig.object3D.position.y + mouseStart.y * planeHeight + aSphereOriginPosition.y ;
				

			}
			
		}
	
		function vrSceneTouchMove(event){
			if (touchState == 1){
				event.preventDefault();

				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mousemove": ////// 20190709 Fei: add this event type for PC mouse
						mouse.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouse.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;

						preMouses.push([mouse.x, mouse.y]);
						preMouses.shift();
						
						break;
					case "touchmove": ////// 20190709 Fei: add this event type for cellphone
						mouse.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouse.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;

						preMouses.push([mouse.x, mouse.y]);
						preMouses.shift();
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousemove/touchmove, return ");
						return ;

				}

				//// 球物件的起始位置為 (0, 1, -1)
				pdiff = mouse.clone().sub(mouseStart) ;
				//// 計算出應該要呈現的位置，從『原始球的位置的z軸數值』與『當前相機垂直fov角度的一半』可以算出『與原始球的xy平面的高度』
				//// 再使用『畫面比例所造成的相機比例』算出『與原始球的xy平面的寬度』
				//// 因為拖拉移動有正負，所以當滑鼠拖拉『從中心到寬邊最距離』對應於『原始球位置到相機最外緣』
				// let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs(aRig.object3D.position.z - aSphereOriginPosition.z) * 1 ;
				let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs( aSphere.object3D.position.z ) * 1 ;
				let planeWidth = planeHeight * aCamera.object3DMap.camera.aspect;

				// aSphere.object3D.position.x = aSphereOriginPosition.x + pdiff.x * planeWidth;
				// aSphere.object3D.position.y = aSphereOriginPosition.y + pdiff.y * planeHeight;
				
				//// 點擊即把球物件移動到滑鼠/觸碰位置
				aSphere.object3D.position.x = mouse.x * planeWidth ;
				// aSphere.object3D.position.y = aRig.object3D.position.y + mouse.y * planeHeight ;
				aSphere.object3D.position.y = aRig.object3D.position.y + mouse.y * planeHeight + aSphereOriginPosition.y ;
				touchMoveTime = Date.now();
				// console.log("vrSceneTouchMove , pdiff =" , pdiff );

			}
		}
	
		function vrSceneTouchEnd(event){
			if (touchState == 1){
				event.preventDefault();
				event.stopPropagation();


				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mouseup": ////// 20190709 Fei: add this event type for PC mouse
						mouseEnd.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseEnd.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;
					case "touchend": ////// 20190709 Fei: add this event type for cellphone
						// console.log("endEvent: touchend: event.touches  = ", event.changedTouches[0].clientX, event.changedTouches[0].clientY );
						mouseEnd.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseEnd.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousedown/touchstart, return ");
						return ;

				}

				//// 假如使用者『持球』過久，則判定沒有選定方向，重來
				if ( Date.now() - touchMoveTime > 200){
					console.log(" ********** touchMove stay too long "  );
					clearTouchState();
					return;
				}

				//// 假如使用者『不是往上投擲』，重來
				if (preMouses[0][1]+0.01 < preMouses[1][1] && preMouses[1][1]+0.01 < preMouses[2][1] ){
					console.log(" ********** direction y up = " , preMouses );
					
				}else if (preMouses[0][1] > preMouses[1][1]+0.01 && preMouses[1][1] > preMouses[2][1]+0.01 ){
					console.log(" ********** direction y down " , preMouses );
					clearTouchState();
					return;
				}else{
					console.log(" ********** direction y not up not down " , preMouses );
					clearTouchState();
					return;
				}
				

				touchState = 2;
				

				//// 投擲預設的球物件
				raycaster.setFromCamera( mouseEnd, aScene.camera );


				let dragX = preMouses[3][0] - preMouses[0][0];
				let dragY = preMouses[3][1] - preMouses[0][1];

				//// 讓遊戲便簡單一點，水平方向限制多一點，讓球不會丟太出去
				// dragX = dragX*0.6; // -0.2 0.2
				// dragY = 0.2 + (dragY*0.5); //0.3-0.6

				// dragX = 0;
				// dragY = 0.5;

				let dragLength = Math.pow( dragX*dragX+dragY*dragY , 0.5);
				console.log("dragLength = " , dragLength , dragX , dragY );

				// if (dragLength<0.1){
				// 	dragLength = 0.1;
				// }else if (dragLength > 0.6){
				// 	dragLength = 0.6;
				// }

				let velocity = new THREE.Vector3( dragX , dragY , -dragY*1.3 ).normalize().multiplyScalar(dragLength*20);
				v2 = velocity.clone().applyEuler( aCamera.object3D.rotation ); //// 改版後
				velocity = v2.clone();

				//// 設計『顯示軌跡』功能，暫時不開放

				//// 2D 銀幕平面上軌跡
				// let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs(aRig.object3D.position.z - aSphereOriginPosition.z) * 1 ;
				// let planeWidth = planeHeight * aCamera.object3DMap.camera.aspect;
				
				// let p2D = document.createElement("a-sphere");
				// p2D.setAttribute("object-type" , "tp");
				// p2D.setAttribute("radius" , 0.02);
				// p2D.setAttribute("material" , "color:#0000ff" );
				
				// aSphere.object3D.position.x = mouse.x * planeWidth ;
				// aSphere.object3D.position.y = aRig.object3D.position.y + mouse.y * planeHeight ;

				//// 3D 空間中軌跡
				let timeStart = Date.now();
				showTrajectory();
				function showTrajectory(){
					if (Date.now() - timeStart > 2500){
						console.log("showTrajectory end");
						let needRemoved = [];
						for (let i = 0, len = aScene.children.length; i< len; i++ ){
							if (aScene.children[i]){
								if (aScene.children[i].getAttribute("object-type") == "tp" ){
									needRemoved.push(aScene.children[i]);
								}
							}
						}
						for (let i = 0, len=needRemoved.length; i< len; i++){
							needRemoved[i].remove();
						}
					}else{
						let tp = document.createElement("a-sphere");
						tp.setAttribute("object-type" , "tp");
						tp.setAttribute("radius" , 0.02);
						tp.setAttribute("material" , "color:#ff0000" );
						// tp.setAttribute("position" , aSphere.object3D.position );
						tp.setAttribute("position" , aSphere.object3D.getWorldPosition(new THREE.Vector3() ) );

						aScene.appendChild(tp);
						setTimeout(showTrajectory, 50);
					}
				}

				let vector = raycaster.ray.direction.multiplyScalar(10);
				// aSphere.setAttribute( "dynamic-body", "mass: 1000" );
				aSphere.setAttribute( "dynamic-body", "mass: 1000; shape: sphere;" );

				// aSphere.body.velocity.set( vector.x, vector.y, vector.z );
				aSphere.body.velocity.set( velocity.x, velocity.y, velocity.z );

				ballAmount -= 1;
				ballAmountText.innerText = "球數: "+ballAmount.toString();
				// resetSphere(2000);
		
				function gameEnd(){

					blocker_score.style.display = "block";

					let userID;
					if ( !localStorage.getItem('userID') || !localStorage.getItem('vendor') ){
						userID = "test1@google";
					}else{
						userID = localStorage.getItem('userID')+"@"+localStorage.getItem('vendor');
					}

					let coins = Math.ceil(score/3);
					let serverUrl = "https://7leyf90jbd.execute-api.ap-northeast-1.amazonaws.com/prod/yongkangMongoAccess";
					let	postData = {
						ID:  userID, 
						coins: coins,
						gameType: "baseballNine",
						request: 'play',
						requestItem: ''
					};
					fetch( serverUrl , {
						method: 'POST', 
						headers: { 'Content-Type': 'application/json'},
						body: JSON.stringify(postData)
					} ).then(function(response) {
						return response.json();
					}).then(function(isPlayed) {
						console.log("baseballNone.html, play isPlayed " , isPlayed );

						postData = {
							ID:  userID, 
							request: 'get',
							requestItem: 'userCoins'
						};
						fetch( serverUrl , {
							method: 'POST', 
							headers: { 'Content-Type': 'application/json'},
							body: JSON.stringify(postData)
						} ).then(function(response) {
							return response.json();
						}).then(function(userCoins) {
							let userCurrentCounts = Number(userCoins[0].currentCoins);

							currentCoins.innerHTML = "結算代幣：" + userCurrentCounts + "枚";

							if ( isPlayed[0] == true ){

								if (score == 0){
									previousCoins.innerHTML = "原有代幣：" + (userCurrentCounts) + "枚";
									getCoins.innerHTML = "新增代幣：" + 1 + "枚";
									score_info.innerHTML = "Sorry! 一個都沒有擊中<br>不過參與遊戲還是可以獲得一個永康幣喔";
								}else{
									previousCoins.innerHTML = "原有代幣：" + (userCurrentCounts - coins) + "枚";
									getCoins.innerHTML = "新增代幣：" + coins + "枚";
									score_info.innerHTML = "恭喜你！擊中" + score + " 格<br>獲得" + coins + "個永康幣";
								}


							}else{
								
								if (score == 0){
									previousCoins.innerHTML = "原有代幣：" + (userCurrentCounts) + "枚";
									getCoins.innerHTML = "新增代幣：" + 1 + "枚";
									score_info.innerHTML = "Sorry! 一個都沒有擊中<br>今日已經遊玩過了，無法獲得永康幣";
								}else{
									previousCoins.innerHTML = "原有代幣：" + userCurrentCounts + "枚";
									getCoins.innerHTML = "新增代幣：" + 0 + "枚";
									score_info.innerHTML = "恭喜你！擊中 " + score + " 格<br>今日已經遊玩過了，無法獲得永康幣";
								}

							}

						});
						

					});

					//// 點擊『去兌換』
					couponPage.onclick = function(){
						location.replace("/prize-list");
					}

					//// 點擊『排行榜』
					leaderBn.onclick = function(){
						postData = {
							ID:  userID, 
							request: 'get',
							requestItem: 'coinLeaderboard'
						};
						fetch( serverUrl , {
							method: 'POST', 
							headers: { 'Content-Type': 'application/json'},
							body: JSON.stringify(postData)
						} ).then(function(response) {
							return response.json();
						}).then(function(leaderList) {
							
							leadBnModal.style.display = 'block';

							console.log("leaderList = " , leaderList );
							let leaderTable = document.getElementById("leaderTable");
							leaderTable.innerHTML = "";
							let thr = leaderTable.insertRow( 0 );
							let t1 = document.createElement('th') , t2 = document.createElement('th') , t3 = document.createElement('th');
							t1.innerHTML = "排名";
							t2.innerHTML = "用戶名稱";
							t3.innerHTML = "代幣數量";
							thr.appendChild(t1);
							thr.appendChild(t2);
							thr.appendChild(t3);
							leaderList.forEach((currentValue, index) => {
								let row = leaderTable.insertRow( index + 1);
								let rankR = row.insertCell(0);
								let nameR = row.insertCell(1);
								let coinsR = row.insertCell(2);
								rankR.style.width = "20%";
								nameR.style.width = "50%";
								coinsR.style.width = "25%";

								let userName;
								if (currentValue.name == ""){
								userName = "user";
								}else{
								userName = currentValue.name;
								}
								rankR.innerHTML = index + 1;
								nameR.innerHTML = userName;
								coinsR.innerHTML = currentValue.cumulativeCoins;
							});
						});

					}

					closeLeadBnModal.onclick = function(){
						leadBnModal.style.display = 'none';
					}


				}

				if(score<9){
					setTimeout(function(){
						if(score==9 || ballAmount == 0){
							gameEnd();
						}
						else{
							resetSphere(1);
						}
						
					}, 2500);
				}else{
					setTimeout(function(){
						if(score==9 || ballAmount == 0){
							gameEnd();
						}
					}, 5000);
				}
				
				// console.log("vrSceneTouchEnd set 2 " , pdiff , "\n", preMouses[3][0] - preMouses[0][0] , preMouses[3][1] - preMouses[0][1] );
				preMouses = [[0,0],[0,0],[0,0],[0,0]];

				// aSphere.object3D.position.x = 0 ;
				// aSphere.object3D.position.y = 1 ;
			}

		}

		function clearTouchState(event){
			if (touchState == 1){
				touchState = 0;
				resetSphere(10);
				console.log("clearTouchState" );
			}
		}

		function resetSphere(time){
			let delay = time? time: 3000;
			setTimeout(function(){
				//// 移除物理性，並且重設位置
				aSphere.removeAttribute( "dynamic-body");
				aSphere.object3D.position.copy(aSphereOriginPosition);
				aSphere.object3D.rotation.set(0, 0, 0);

				touchState = 0;
				// console.log("resetSphere set 0" );
			}, delay);
		}


		let self = {};
		let videoScene = new THREE.Scene();
		self.videoScene = videoScene;
		self.GLRenderer = aScene.renderer;
		aScene.renderer.autoClear = false;
		self.aScene = aScene;

		// renderTick();
		startCamera( function(){
			renderTick();	
			if (self.video){
				self.video.play();
			}
		});

		function renderTick(){
			
			if (self.videoCamera){
				self.GLRenderer.render( self.videoScene, self.videoCamera);
			}	
			self.GLRenderer.clearDepth();
			if (self.aScene.object3D && self.aScene.camera){
				self.GLRenderer.render( self.aScene.object3D, self.aScene.camera );
			}

			// console.log("renderTick");
			requestAnimationFrame(renderTick); // dont use it, because of the haning problem
		};



		function startCamera( callback ){

			let video = document.createElement('video');
			let configuration = { facing: "environment" };
			let texture = new THREE.VideoTexture(video);
			texture.minFilter = THREE.LinearFilter;
			texture.flipY = false;
			texture.format = THREE.RGBFormat; // THREE.RGBAFormat



			console.log(" _startCamera dcwh= " , document.documentElement.clientWidth , document.documentElement.clientHeight );

			if ( navigator.mediaDevices  ) {
				let onError = function(err) { 
					console.error(" _startCamera error:", err); 
					//// 即使沒開相機，也能玩
					if (callback){
						callback();
					}
				};

				let videoSuccess = function(stream){
					window.videoStream = stream;
					video.srcObject = stream;
					video.playsInline = true;
					video.onloadedmetadata = function() {
						function tick_video(){
							if (video.videoWidth > 200 || video.videoHeight > 200){
								console.log("XRFunc.js: tick_video play video[w, h]=", video.videoWidth, video.videoHeight );
								//// 將video 物件記錄下來，在後面等 renderer 開始工作後再啟動
								self.video  = video;
								// video.play();

								//////// set the div size depend on video
								let videoWidth, videoHeight;
								let aDiv = document.getElementById("aDiv");
								let w, h;
								if ( document.documentElement.clientWidth/document.documentElement.clientHeight > video.videoWidth/video.videoHeight ){
									
									w = window.innerWidth  ;
									h = (window.innerWidth/video.videoWidth)* video.videoHeight;

									console.log(" 1 set div size = ", innerWidth, innerHeight, w ,h, videoWidth, videoHeight );
								}else{
									
									w = (window.innerHeight/video.videoHeight) * video.videoWidth ;
									h = window.innerHeight;
									
									console.log(" 2 set div size = ", innerWidth, innerHeight, w ,h, videoWidth, videoHeight );
								}

								//// full fill, left nothing blank
								aDiv.style.width  = w + "px" ;
								aDiv.style.height = h + "px" ;
								//// align the div and body
								aDiv.style.left = ( innerWidth - w )/2 + "px" ;
								aDiv.style.top  = ( innerHeight - h )/2 + "px" ;
								

								aScene.resize(); ////// it must call after renderer resize

								////// setup the camera for 2D scene( 20200314 useless )
								// let camera2D = new THREE.OrthographicCamera( -w/2, w/2, -h/2, h/2, -10, 20000);
								//// 20201110 fei: 設定相機跟背景的時候直接使用『實體相機畫面尺寸』作為設定，手機端基本是[480, 640] 電腦端基本是[640, 480]
								videoWidth = texture.image.videoWidth,  videoHeight = texture.image.videoHeight;

								
								////// setup the camera for background video
								let videoCamera = new THREE.OrthographicCamera( -videoWidth/2, videoWidth/2, -videoHeight/2, videoHeight/2, -10, 20000);
								self.videoCamera = videoCamera;
								
								////// setup videoPlane
								let videoPlane = new THREE.Mesh(
									new THREE.PlaneBufferGeometry( videoWidth , videoHeight ),
									new THREE.MeshBasicMaterial( { map:texture, side: THREE.DoubleSide } ) ,
								);
								// videoPlane.material.depthTest = false;
								// videoPlane.material.depthWrite = false;
								videoPlane.position.set(0, 0, -1 );
								self.videoScene.add( videoPlane );
								
								if ( callback ) { callback(); }

							}else{
								console.log("tick_video else video[w, h]=", video.videoWidth, video.videoHeight );
								setTimeout(tick_video, 100);
							}
						}

						if ( self.videoCamera ){
							console.log("_startCamera: videoCamera exist, donothing ");
						}else{
							console.log("_startCamera: videoCamera not exist, start video ");
							tick_video();
						}
						
					}
					
				}

				
				navigator.mediaDevices.enumerateDevices().then(function(devices) {
					let useDeviceID = false;
					let cameraID, facingString, video_constraints;
					devices = devices.filter(function(devices) { return devices.kind === 'videoinput'; });
					if ( configuration.facing == "environment" ){facingString = "back";} 
					else if (configuration.facing == "user" ){facingString = "front";} 
					else{facingString = "back";}
					for (let i in devices){
						if( devices[i].label.toLowerCase().search( facingString ) != -1  ){ // front back
							cameraID = devices[i].deviceId;
							useDeviceID = true;
						}
					}
					if (useDeviceID){ // PC, android chrome/FireFox, use the specific id by labels.
						console.log("useDeviceID true, cameraID=", cameraID );
						video_constraints = {
							video: {
								width: { min: 320, ideal: 640, max: 1280 },
								height: { min: 240, ideal: 480, max: 800 }, 
								frameRate: { min:15, ideal: 30, max: 60 },
								deviceId: {'exact':cameraID }
							}
						};
					}else{
						let facing;
						if ( configuration.facing ){ //// usually iOS safari and QQ, use "user"/"environment" to start
							facing = configuration.facing;
							console.log("configuration.facing do exist: set facing = ", facing );
							video_constraints = {
								video: {
									width: { min: 320, ideal: 640, max: 1280 },
									height: { min: 240, ideal: 480, max: 800 }, 
									frameRate: { min:15, ideal: 30, max: 60 },
									facingMode: facing
								}
							};
						}else{
							console.log("configuration.facing dosent exist: set facing = environment" );
							video_constraints = {
								video: {
									width: { min: 320, ideal: 640, max: 1280 },
									height: { min: 240, ideal: 480, max: 800 }, 
									frameRate: { min:15, ideal: 30, max: 60 },
									facingMode: 'environment'
								}
							};
						}
					}

					navigator.mediaDevices.getUserMedia( video_constraints ).then(videoSuccess, onError); // successCallback
				
				});

			}

			console.log(" +++++++ ");
		}



	</script>

</body>
</html>

