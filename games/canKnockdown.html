<!doctype html>
<html >
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>丟罐子小遊戲</title>
	<link href="./styles/back_to_menu.css" rel="stylesheet">
	<link href="./styles/fraction.css" rel="stylesheet">
	<link href="./styles/scoreCheck.css" rel="stylesheet">
	<style>

		html, body {
			overflow: hidden;
			background: #fff;
			color: #000;
			font-family: sans-serif;
			text-align: center;
			width:100vw;
			height:100vh;
			margin: 0;

			outline:none;
			-webkit-tap-highlight-color: rgba(0,0,0,0);
			-moz-user-select: none;
			-webkit-user-select: none; 
			-ms-user-select:none; 
			user-select:none;
			-o-user-select:none;
		}

		#aDiv{
			/* margin: 20px 10px; */
			/* width:800px; */
			/* height:600px; */
			overflow: hidden;
			position: relative;
			width:100vw;
			height:100vh;
		}

		@media screen and (min-width: 300px) and (max-width: 700px) {
			#aDiv{
				/* margin: 20px 10px; */
				/* width:400px; */
				/* height:300px; */
				position: relative;
				width:100vw;
				height:100vh;
			}
		}

		#blocker {
			position: absolute;
			width: 100vw;
			height: 100vh;
			background-color: rgba(0,0,0,0.8);
			z-index: 1;
			pointer-events: none;
			display: none;
			font-family: "Microsoft JhengHei","微軟正黑體";
		}

		#blockerTitle{
			font-size: 24pt;
			text-align: center;
			color: white;
			margin-top:5%;
			margin-bottom: 10px;
		}

		#blockerInfo{
			font-size: 16pt;
			text-align: center;
			color:white;
			margin-top:10%;
			margin-bottom: 10px;
		}

		#blockState{
			font-size: 16pt;
			text-align: center;
			color:#F47165;
			margin-top:10%;
			margin-bottom: 10px;
			animation: scale-change 2s infinite;
			animation-timing-function: linear;
		}

		@keyframes scale-change {
			0% {
				transform: scale(0.9);
			}
			50%{
				transform: scale(1.1);
			}
			100% {
				transform: scale(0.9);
			}
		}

		.modal {
			display: none; /* Hidden by default */
			position: fixed; /* Stay in place */
			z-index: 1; /* Sit on top */
			left: 0;
			top: 0;
			/* https://stackoverflow.com/questions/10075524/sizing-div-based-on-window-width/35237091#35237091 */
			width: 100vw; /* Full width */
			height: 100vh; /* Full height */
			background-color: rgba( 74 , 77 , 84 , 0.85 ); /* Black w/ opacity */
		}

		/* Modal Content/Box */
		.modal-content {
			position: relative;
			/* background-color: #202125; */
			margin: auto;
			top: 15%;
			border-radius: 16px;
			width: 85vw;
			height: 75vh;
			/* overflow: auto; */
		}

		.modal-content > div {
			position: relative;
			/* margin-left: 2%; */
			/* margin-right: 2%; */
			/* width: 90%; */
			color:white;
			text-align: center;
			font-size: 20pt;
		}


		.centerText {
			margin: 0;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			white-space:nowrap;
		}
		
		/* 結算畫面  ----------------------- start ---------------------------  */

		#blocker_score {
			display: none;
			position: absolute;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.7);
			z-index: 1;
		}

		#previousCoins{
			margin-top: 40px;
		}

		#getCoins{
			margin-top: 20px;
		}

		#currentCoins{
			margin-top: 20px;
		}

		#score_info{
			right:-40%;
			width:50%;
			height:auto;
			font-size:18px; 
			color:#00c99c;
			border: 2px solid white;
			padding:10px;
		}

		#leaderBn , #leaveConfirm {
			position:absolute;
			bottom: 15px;
			left:3px;
			width:40%;
			height:20%;
			max-height: 50px;
			border-radius: 20px;
			background-color: rgba(80, 160, 150, 1.0);
			cursor: pointer;
		}

		#couponPage, #leaveCancel{
			position:absolute;
			bottom: 15px;
			right:3px;
			width:40%;
			height:20%;
			max-height: 50px;
			border-radius: 20px;
			background-color: rgba(80, 110, 150, 1.0);
			cursor: pointer;
		}

		/* 結算畫面  ----------------------- end ---------------------------  */

		/* 排行榜    ----------------------- start --------------------------- */

		#leaderModalDiv{
			z-index: 2;
		}

		#leaderModalContentDiv{
			position: relative;
			margin: auto;
			top: 5%;
			border-radius: 16px;
			width: 85vw;
			height: 75vh;
		}

		#leaderModalBGDiv {
			top:0%;
			left:0%;
			width:100%;
			height:100%;
			position: absolute;
		}

		#leaderModalBGImg{
			left: 0%;
			top: 0%;
			width: 100%;
			height:100%;
			object-fit: fill;
		}
		
		#leaderModalBGTopDiv {
			left:3%;
			top:0%;
			width:94%;
			height:10%;
			position: absolute;
		}

		#leaderModalTopImg{
			left: 0%;
			top: 0%;
			width: 100%;
			height:100%;
			object-fit: fill;
		}

		#leaderModalBGTopInfo {
			position: absolute;
			top:50%;
			margin:0;
			color:white;
			font-size: 30pt;
		}

		#leaderModalCancel  {
			position: absolute;
			top:-20px;
			right:-20px;
			width:15%;
			height:15%;
			max-width: 74px;
			max-height: 74px;
			object-fit: contain;
		}

		#leaderModalTable{
			position: absolute;
			margin: auto;
			width:94%;
			height:70%;
			top:12%;
			left:3%;
			color:black;
			font-size:14pt;
			overflow-wrap:anywhere;
		}

		#leaderModalButtonDiv {
			position: absolute;
			bottom: 4%;
			width:100%;
			height:10%;
		}

		#leaderModalComfirm {
			position: absolute;
			width:50%;
			left:25%;
			top: 0%;
		}

		#leaderModalComfirmImg {
			width:100%;
			height: 100%;
			max-width: 370px;
			max-height: 86px;
			object-fit: contain;
		}


		.rankRow{
			position: relative;
			width:90%;
			height:8%;
			left:4%;
			margin-top: 1%;
		}

		.rankNumeralDiv{
			position: absolute;
			width:10%;
			height: 100%;
			left: 0%;
		}

		.rankNameInfoDiv{
			position: absolute;
			width:85%;
			height: 100%;
			left: 15%;
		}

		.rankNumeralImg, .rankNameInfoImg{
			width: 100%;
			height:100%;
			object-fit: fill;
		}

		.nameInfoTextDiv{
			position: absolute;
			width:70%;
			height: 100%;
			top:0%;
			left:0%;
			border-right-style: solid;
			border-right-width: 1px;
			border-right-color: #F47165;
		}

		.nameInfoNumberDiv{
			position: absolute;
			width:30%;
			height: 100%;
			top:0%;
			left:70%;
		}

		.centerP {
			margin: 0;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			white-space:nowrap;
		}

		/* 排行榜    ----------------------- end --------------------------- */


		/* 載入頁面 -------------------------- start  -------------------------- */

		#loadPage{
			display: block;
			position: absolute;
			top:0px;
			width:100vw;
			height:100vh;
			background-color: rgba(128,128,128,0.5);
			z-index: 1;
			text-align: center;
			font-size: 32pt;
			line-height: 80vh;
		}

		#loadImg{
			object-fit: fill;
			position: absolute;
			top:0%;
			left:0%;
			width:100vw;
			height:100vh;
		}

		#loadObject{
			position: absolute;
			top:10%;
			left:40%;
			font-size: 18pt;
			color: #F47165;
		}

		.lds-ellipsis {
			display: inline-block;
			position: relative;
			left: calc(25% - 105px);
			width: 50%;
			height: 20%;
		}

		.lds-ellipsis img {
			position: absolute;
			top: 0;
			left: 0;
			object-fit: contain;
			width:100%;
			height:100%;
		}

		.lds-ellipsis div {
			position: absolute;
			top: 33px;
			width: 33px;
			height: 33px;
			border-radius: 50%;
			/* background: #000000; */
			animation-timing-function: cubic-bezier(0, 1, 1, 0);
		}
		.lds-ellipsis div:nth-child(1) {
			left: 0px;
			animation: lds-ellipsis1 0.6s infinite;
		}
		.lds-ellipsis div:nth-child(2) {
			left: 0px;
			animation: lds-ellipsis2 0.6s infinite;
		}
		.lds-ellipsis div:nth-child(3) {
			left: 64px;
			animation: lds-ellipsis2 0.6s infinite;
		}
		.lds-ellipsis div:nth-child(4) {
			left: 128px;
			animation: lds-ellipsis2 0.6s infinite;
		}
		.lds-ellipsis div:nth-child(5) {
			left: 192px;
			animation: lds-ellipsis3 0.6s infinite;
		}
		@keyframes lds-ellipsis1 {
			0% {
				transform: scale(0);
			}
			100% {
				transform: scale(1);
			}
		}
		@keyframes lds-ellipsis3 {
			0% {
				transform: scale(1);
			}
			100% {
				transform: scale(0);
			}
		}
		@keyframes lds-ellipsis2 {
			0% {
				transform: translate(0, 0);
			}
			100% {
				transform: translate(64px, 0);
			}
		}

		/* 載入頁面 -------------------------- end  -------------------------- */

	</style>


</head>
<body>
	
	<script src = "/scripts/main.js"></script>

	<div id = "loadPage">
		
		<img id = "loadImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/bg/img/2.png" >
		<div class="lds-ellipsis">
			<div><img src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/progress bar/img.png"></div>
			<div><img src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/progress bar/img.png"></div>
			<div><img src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/progress bar/img.png"></div>
			<div><img src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/progress bar/img.png"></div>
			<div><img src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/progress bar/img.png"></div>
			<div></div>
		</div>
		
		<div id = "loadObject"> 載入中 </div>
	</div>

	<div id = "backToWix" >
		<img id = "backToWixImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/button/come back wix/normal.png">
	</div>

	<div id="leaveWarningModalDiv" class="modal" style="display: none;">
		<div id = "leaveWarningModalContent" class="modal-content">
			<div id ="leaveWarningBGDiv" >
				<img id = "leaveWarningBGImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/pop up/bottom/white.png">
		  	</div>
  
		  	<img id = "leaveWarningCancel" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/button/delete/normal.png">
  
		  	<div id = "leaveWarningInfo"  >
				<div id = "leaveWarningInfoText">
			  		確認回到活動網站嗎？
				</div>
		  	</div>
  
			<div id="leaveWarningButtonDiv">
				<div id="leaveWarningComfirm">
					<img id = "leaveWarningComfirmImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/button/confirm/normal.png">
				</div> 
			</div>
  
		</div>
	</div>

	<div id="blocker">
		<div class="modal-content">
			<div id = "blockerTitle">
				丟罐子小遊戲
			</div>
			<div id = "blockerInfo"> 
				遊戲介紹：<br>
				滑鼠/手指滑動螢幕來丟球<br>
				總共3球，看看你能夠得到幾分吧<br>
				手機上請轉動裝置來瞄準<br>
			</div>
			<div id = "blockState">
				請點擊螢幕來開始遊戲
			</div>
		</div>
	</div>
	
	<div id="fraction">
		<img id="fractionImg" src= "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/game/fraction.png">
		<img id="dividerImg" src= "images/fraction_divider.png">
		<div id="score" >
			<div id = "scoreText">
				目前擊中: 0 罐
			</div>
		</div>
		<div id ="ballAmountDiv">
			<div id="ballAmount">
				球數： 3
			</div>
		</div>
	</div>

	<!-- 排行榜區 -->
    <div id="leaderModalDiv" class = "modal" style="display: none;">
		<div id = "leaderModalContentDiv" class="modal-content">
		  
		  <div id ="leaderModalBGDiv">
			<img id = "leaderModalBGImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/fraction/pink bottom.png">
		  </div>
  
		  <div id ="leaderModalBGTopDiv" >
			<img id = "leaderModalTopImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/pop up/top bar/red.png">
			<div id = "leaderModalBGTopInfo" class = "centerText"> 排行榜 </div>
		  </div>
  
		  <img id = "leaderModalCancel" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/button/delete/normal.png">
  
		  <div id = "leaderModalTable" ></div>
  
		  <div id="leaderModalButtonDiv">
			<div id="leaderModalComfirm">
			  <img id = "leaderModalComfirmImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/button/confirm/normal.png">
			</div> 
		  </div>
		</div>  
	</div>

	<!-- 遊戲結算區 -->
	<div id = "scoreCheckPageDiv" style=" display: none; position: fixed; z-index: 1; text-align: center;" > 
		<div id = "bgImgDiv">
			<img id = "bgImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/bg/img/1.png">
		</div>
		<div id = "bgModelImgDiv">
			<img id = "bgModelImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/img/milo2.png">
		</div>
		<div class="modal-content2">

			<div id= "scoreCheckDiv">
				<div id = "scoreCheckBGDiv">
					<img id = "scoreCheckBGImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/fraction/pink bottom.png">
				</div>

				<div id = "scoreCheckBGTopDiv">
					<img id = "scoreCheckBGTopImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/pop up/top bar/red.png">
					<div id = "scoreCheckTopText">遊戲結算</div>
				</div>

				<div id= "previousCoinsDiv">
					<img id = "previousCoinsBGImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/fraction/white.png">
					<div id= "previousCoinsImgDiv">
						<img id = "previousCoinsImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/img/yongkang coin.png">
					</div>
					<div id = "previousCoinsText">原有永康幣</div>
					<div id = "previousCoinsAmountText">0 枚</div>
				</div>

				<div id= "getCoinsDiv">
					<img id = "getCoinsBGImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/fraction/white.png">
					<div id= "getCoinsImgDiv">
						<img id = "getCoinsImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/img/yongkang coin.png">
					</div>
					<div id = "getCoinsText">此次獲得永康幣</div>
					<div id = "getCoinsAmountText">0 枚</div>
				</div>

				<div id="coninDividerDiv">
					<img id="coninDividerImg" src= "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/divider/pink.png">
				</div>

				<div id= "currentCoinsDiv">
					<img id = "currentCoinsBGImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/fraction/white.png">
					<div id= "currentCoinsImgDiv">
						<img id = "currentCoinsImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/img/yongkang coin.png">
					</div>
					<div id = "currentCoinsText">結算永康幣</div>
					<div id = "currentCoinsAmountText">0 枚</div>
				</div>
	
			</div>

			<div id = "playResultDiv">
				<img id = "playResultImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/login/dialogue.png">
				<div id = "playResultTextDiv">
					<div id = "playResultText"></div>
				</div>
			</div>

			<div id = "leaderBdDiv" >
				<img id = "leaderBdImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/button/fraction/normal.png">
			</div>

			<div id = "prizeListDiv" >
				<img id = "prizeListImg" src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/button/award redemption/smoll/normal.png">
			</div>

		</div>
		
	</div>

	<audio id = "bgAudio" autoplay >
		<source src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/sound/backgroundAll.mp3" type="audio/mpeg">
	</audio>

	<script src="js/vconsole.min.js"></script>
	<script>
		// if ( window.navigator.userAgent.toLowerCase().indexOf("mobile") >= 0 && window.navigator.userAgent.toLowerCase().indexOf("chrome") < 0 ){
		if ( window.navigator.userAgent.toLowerCase().indexOf("mobile") >= 0 ){
			// var vConsole = new VConsole();
			console.log("The system is mobile: ", window.navigator.userAgent.toLowerCase() );
		}else{
			console.log("The system is PC: ", window.navigator.userAgent.toLowerCase() );
		}

		//// 點擊任意位置播放背景音樂
		document.getElementById("bgAudio").loop = true;
		document.onclick = function(){
			document.getElementById("bgAudio").play();
		}

		//// 排行榜開關
		leaderBdImg.onclick = function(){
			leaderModalDiv.style.display = "block";
		}
		leaderModalCancel.onclick = function(){
			leaderModalDiv.style.display = "none";
		}
		leaderModalComfirmImg.onclick = function(){
			leaderModalDiv.style.display = "none";
		}

		//// 處理『返回活動首頁』
		backToWix.onclick = function(){
      		leaveWarningModalDiv.style.display = "block";
		}

		leaveWarningCancel.onclick = function(){
			leaveWarningModalDiv.style.display = "none";
		}

		leaveWarningComfirm.onclick = function(){
			// location.href = "/prize-list/index.html";
			
			let currectDate = new Date();
			let y = currectDate.getYear();
			let m = currectDate.getMonth() + 1;
			let d = currectDate.getDate()  + 0;
			if (y==120 && m == 12 && d < 28){
				location.href = "/prize-list/index.html";
			}else {
				location.href = "/index.html";
			}
		}

		//// 只有特定日期才可以遊玩
		checkGameDate();
		function checkGameDate(){
			let currectDate = new Date();
			let y = currectDate.getYear();
			let m = currectDate.getMonth() + 1;
			let d = currectDate.getDate()  + 0;
			if (y == 120 && m == 12){

				if (d >= 28 ){
					scoreCheckPageDiv.style.display = "none";
					return;
				}

				switch( d%4 ){
					case 1:
					//// 9 13 17 21 25 29 射氣球 不可遊玩
					location.href = "/index.html";
					break;
					case 2:
					//// 10 14 18 22 26 30 丟罐子 可以遊玩
					// location.href = "/index.html";
					break;
					case 3:
					//// 7 11 15 19 23 27 31 拉霸機 不可遊玩
					location.href = "/index.html";
					break;
					case 0:
					//// 12 16 20 24 28  棒球九宮格 不可遊玩
					location.href = "/index.html";
					break;
				}
			}else{
				scoreCheckPageDiv.style.display = "none";
			}
		}

		
	</script>

	<script src="js/aframe-v1.0.4.js"></script>
	<script src="js/aframe-extras.js"></script>

	<script src="js/aframe-physics-system.js"></script>
	<script src="js/aframe-physics-extras.min.js"></script>

	<!-- <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script> -->

	<div id = "aDiv"  >
		<a-scene id = "aScene" embedded="" vr-mode-ui="enabled: false" 
		device-orientation-permission-ui="enabled: true"  shadow="type: pcfsoft"
		physics="debug: false; friction: 0.002; maxInterval: 0.025;" 
		gltf-model="dracoDecoderPath: js/draco/">
			<a-assets id = "aAssets" timeout = "20000">

				<a-asset-item id="_Hoonie" name="虎妮" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/Hoonie.glb"></a-asset-item>
				<!-- <a-asset-item id="_Hoonie" name="虎妮" src="model/Hoonie.glb"></a-asset-item> -->

				<a-asset-item id="_cheering" name="加油版" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/cheering.glb"></a-asset-item>

				<a-asset-item id="basketball" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/basketball_FBX.glb"></a-asset-item>

				<a-asset-item id="jar1" name="罐子 1" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/Jar1.glb"></a-asset-item>
				<a-asset-item id="jar2" name="罐子 2" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/Jar2.glb"></a-asset-item>
				<a-asset-item id="jar3" name="罐子 3" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/Jar3.glb"></a-asset-item>
				<a-asset-item id="jar4" name="罐子 4" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/Jar4.glb"></a-asset-item>
				<a-asset-item id="jar5" name="罐子 5" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/Jar5.glb"></a-asset-item>

				<a-asset-item id="_desk" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/desk.glb"></a-asset-item>
				<a-asset-item id="_flyfloor" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/flyfloor.glb"></a-asset-item>
				
				<a-asset-item id="_basket" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/basket_basketball.glb"></a-asset-item>

				<a-asset-item id="_backgroundBoard" src="https://yongkangfile.s3-ap-northeast-1.amazonaws.com/ARGame/games/model/background(high).glb"></a-asset-item>


			</a-assets>

			<a-entity id="rig" position="0 0.8 3.0" rotation="0 0 0">
				<!-- <a-entity id="aCamera" camera  look-controls wasd-controls></a-entity> -->
				<!-- <a-entity id="aCamera" camera="fov:80; zoom:1" > -->
				<a-entity id="aCamera" camera="fov:80; zoom:1"  look-controls="touchEnabled:false" wasd-controls>
					<!-- 棒球本身 -->
					<a-entity visible = "true" id = "aSphere" position="0 -1.0 -2.0" rotation="0 0 0" scale=" 0.7 0.7 0.7 " gltf-model="#basketball" ></a-entity>


				</a-entity>
			</a-entity>
			
			<!-- 籃球本身 -->
			<!-- <a-entity visible = "true" id = "aSphere" position="0 0.1 -1.0" rotation="0 0 0" scale=" 0.5 0.5 0.5 " gltf-model="#basketball" ></a-entity> -->

			<!-- 虎泥 -->
			<a-entity visible = "true" id = "Hoonie" position="5 -2 -4.5" rotation="0 -30 0" scale=" 2.5 2.5 2.5 " gltf-model="#_Hoonie" ></a-entity>

			<!-- 加油版 -->
			<a-entity visible = "true" id = "cheering" position="2 2.5 -2" rotation="0 0 0" scale=" 2.5 2.5 2.5 " gltf-model="#_cheering" ></a-entity>

			<!-- 背景看板 -->
			<a-entity visible = "true" id = "backgroundBoard" position="0 -2 -3.2" rotation="0 0 0" scale=" 1.5 1.5 1.5 " gltf-model="#_backgroundBoard" ></a-entity>

			<!-- 置物桌 -->
			<a-entity visible = "true" id = "desk" position="0 -2.5 -2.8" rotation="0 0 0" scale="2.0 2.0 0.35" gltf-model="#_desk" static-body ></a-entity>

			<!-- 裝飾籃球架 -->
			<a-entity visible = "true" id = "basket" position="-2 -2 -1.2" rotation="0 0 0" scale="0.7 0.7 0.7" gltf-model="#_basket" ></a-entity>


			<!-- 丟沙包 -->
			
			<!-- 罐子塔 -->
			<!-- 罐子塔 -->
			<!-- 最下層 -->
			<a-entity visible = "true" id = "can7" position="-1.35 0.114 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar1"  ></a-entity>

			<a-entity visible = "true" id = "can8" position="-0.45 0.114 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar2"  ></a-entity>

			<a-entity visible = "true" id = "can9" position="0.45 0.114 -3" rotation="0 180 0" scale= "0.6 0.6 0.6" gltf-model="#jar3"  ></a-entity>

			<a-entity visible = "true" id = "can10" position="1.35 0.114 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar4"  ></a-entity>

			<!-- 第三層 -->
			<a-entity visible = "true" id = "can4" position="-0.9 1.048 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar5"  ></a-entity>

			<a-entity visible = "true" id = "can5" position="0.0 1.048 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar1"  ></a-entity>

			<a-entity visible = "true" id = "can6" position="0.9 1.048 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar2"  ></a-entity>

			<!-- 第二層 -->
			<a-entity visible = "true" id = "can2" position="-0.45 1.982 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar3"  ></a-entity>

			<a-entity visible = "true" id = "can3" position="0.45 1.982 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar4"  ></a-entity>

			<!-- 最上層 -->
			<a-entity visible = "true" id = "can1" position="0 2.917 -3" rotation="0 180 0" scale="0.6 0.6 0.6" gltf-model="#jar5"  ></a-entity>


			
			<!-- 隱形地板，碰撞用 -->
			<a-plane id="underplane1" position="0 -2 0" rotation="-90 0 0" width="50" height="50" visible="false" shadow="receive: true" static-body></a-plane>

			<!-- 裝飾地板 -->
			<a-entity visible = "true" id = "flyfloor" position="0 -2 -4" rotation="0 0 0" scale="4.3 4.3 3.3" gltf-model="#_flyfloor" ></a-entity>




			<!-- <a-sky id = "aSky" color="#ECECEC"></a-sky> -->
			<a-entity light="type: ambient; color: #FFFFFF;"></a-entity>
			<a-entity light="type: directional; color: #FFFFFF; intensity: 0.9;
								   castShadow: true; 
								   shadowCameraVisible: false;
								   shadowBias:-0.0005; 
								   shadowCameraTop:10; shadowCameraBottom:-10; 
								   shadowCameraRight:10; shadowCameraLeft:-10; 
								   shadowMapHeight:3072; shadowMapWidth:3072; 
								   shadowCameraFar: 500; shadowCameraNear: 0.5;" 
			          position="0 0 1"></a-entity>

		</a-scene>

	</div>	

	<script>

		//// 處理載入畫面，呈現當時載入狀況
		let isRenderTick = false, sceneReady = false;
		let assetList = [];
		document.getElementById("aAssets").addEventListener("progress", function(ret){
			// console.log(" _aAssets: progress: ret=" , ret.target.id , ret  );
			// loadObject.innerHTML = ret.target.id + "," + (ret.detail.loadedBytes/ret.detail.totalBytes) ;

			if (ret.detail.loadedBytes == ret.detail.totalBytes ){
				console.log(" _aAssets: progress: ret=" , ret.target.id , "done"  );
				// loadObject.innerHTML = ret.target.id + " done"   ;
				assetList.push(ret.target.id);
			}
			if (assetList.length == document.getElementById("aAssets").children.length ){
				console.log(" _aAssets: progress: load done ? ");
				// loadObject.innerHTML = "物件載入完成";
				sceneReady = true;
			}
		});

		document.getElementById("aScene").addEventListener("loaded", function(){
			console.log(" _aScene: loaded " );
			loadObject.innerHTML = "場景載入完成";
			sceneReady = true;
		});
		
		document.getElementById("aScene").addEventListener("renderstart", function(){
			console.log(" _aScene: renderstart " );
			loadObject.innerHTML = "場景繪製";
			sceneReady = true;
		});
		
		removeLoadingPage();
		function removeLoadingPage(){
			if (isRenderTick == true && sceneReady == true ){
				loadPage.style.display = "none";

				//// 顯示前置頁面
				blocker.style.display = "block";
				blocker.style.pointerEvents = "auto";
				blockState.innerHTML = "請點擊螢幕來開始遊戲";
				blocker.onclick =  function(){
					blocker.style.display = "none";
				}

				console.log("hidden the loadingPage");
			}else{
				console.log("_removeLoadingPage: not yet" , isRenderTick , sceneReady );
				setTimeout( removeLoadingPage , 100);
			}
		}

		//// 處理各個罐子材質，無光標準
		//// 處理架子材質，無光標準

		function setModelMesh(evt){
			let objj = evt.detail.model;
			objj.traverse(node => {
				if (node.isMesh) {
					node.material = new THREE.MeshBasicMaterial({color: new THREE.Color(1,1,1), name: node.name, skinning: node.material.skinning, map: node.material.map});
					if (node.material.map){
						node.material.map.encoding = THREE.GammaEncoding;
						node.material.map.needsUpdate = true;
					}
					node.material.needsUpdate = true;
				}
			});
		}
		function setModelMeshResetCan(evt){
			let objj = evt.detail.model;
			objj.traverse(node => {
				if (node.isMesh) {
					node.material = new THREE.MeshBasicMaterial({color: new THREE.Color(1,1,1), name: node.name, skinning: node.material.skinning, map: node.material.map});
					if (node.material.map){
						node.material.map.encoding = THREE.GammaEncoding;
						node.material.map.needsUpdate = true;
					}
					node.material.needsUpdate = true;
				}
			});
			// console.log(" --- " , objj );
			objj.position.y = -0.7785; //// 手動調整出來的數字
		}
		can1.addEventListener('model-loaded', setModelMeshResetCan );
		can2.addEventListener('model-loaded', setModelMeshResetCan );
		can3.addEventListener('model-loaded', setModelMeshResetCan );
		can4.addEventListener('model-loaded', setModelMeshResetCan );
		can5.addEventListener('model-loaded', setModelMeshResetCan );
		can6.addEventListener('model-loaded', setModelMeshResetCan );
		can7.addEventListener('model-loaded', setModelMeshResetCan );
		can8.addEventListener('model-loaded', setModelMeshResetCan );
		can9.addEventListener('model-loaded', setModelMeshResetCan );
		can10.addEventListener('model-loaded', setModelMeshResetCan );

		//// 延後設置罐子的物理性質。應該可以比較不會亂彈跳
		can7.setAttribute("dynamic-body", "mass:1000; shape:cylinder;");
		can7.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can8.setAttribute("dynamic-body", "mass:1000; shape:cylinder;");
		can8.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can9.setAttribute("dynamic-body", "mass:1000; shape:cylinder;");
		can9.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can10.setAttribute("dynamic-body", "mass:1000; shape:cylinder;");
		can10.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");

		can4.setAttribute("dynamic-body", "mass:500; shape:cylinder;");
		can4.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can5.setAttribute("dynamic-body", "mass:500; shape:cylinder;");
		can5.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can6.setAttribute("dynamic-body", "mass:500; shape:cylinder;");
		can6.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can2.setAttribute("dynamic-body", "mass:500; shape:cylinder;");
		can2.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can3.setAttribute("dynamic-body", "mass:500; shape:cylinder;");
		can3.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");
		can1.setAttribute("dynamic-body", "mass:500; shape:cylinder;");
		can1.setAttribute("sleepy", "allowSleep: true; delay:1; linearDamping: 0.01; angularDamping: 0.01");


		//// 將 『背景看板』『置物桌』『置物籃』調整為無光標準
		backgroundBoard.addEventListener('model-loaded', setModelMesh );
		desk.addEventListener('model-loaded', setModelMesh );
		basket.addEventListener('model-loaded', setModelMesh );
		document.getElementById("aSphere").addEventListener('model-loaded', setModelMesh );

		//// 將 『浮空地板』調整為無光標準，並且增加動畫
		flyfloor.setAttribute("animation-mixer" , "clip: Take 001");
		flyfloor.addEventListener('model-loaded', function (evt){
			let objj = evt.detail.model;
			objj.traverse(node => {
				if (node.isMesh) {
					node.material = new THREE.MeshBasicMaterial({color: new THREE.Color(1,1,1), name: node.name, skinning: node.material.skinning, map: node.material.map});
					if (node.material.map){
						node.material.map.encoding = THREE.GammaEncoding;
						node.material.map.needsUpdate = true;
					}
					node.material.needsUpdate = true;
				}
			});
			let animationSlices = [];
			animationSlices.push({ 
				changed:false, 
				loop:true, 
				reset:true, 
				stopHead: false,
				count: 0, 
				idle:"mifly168", 
				uid:"mifly168" 
			});
			animationSlices.push({
				animationName: evt.detail.model.animations[0].name,
				name: evt.detail.model.animations[0].name,
				endTime: evt.detail.model.animations[0].duration ,
				startTime: 0,
				uid:"mifly168"
			});
			evt.detail.model.animationSlices = animationSlices;
		} );

		cheering.setAttribute("animation-mixer" , "clip: Take 001");
		cheering.addEventListener('model-loaded', function (evt){
			let objj = evt.detail.model;
			objj.traverse(node => {
				if (node.isMesh) {
					node.material = new THREE.MeshBasicMaterial({color: new THREE.Color(1,1,1), name: node.name, skinning: node.material.skinning, map: node.material.map});
					if (node.material.map){
						node.material.map.encoding = THREE.GammaEncoding;
						node.material.map.needsUpdate = true;
					}
					node.material.needsUpdate = true;
				}
			});

			let animationSlices = [];
			animationSlices.push({ 
				changed:false, 
				loop:true, 
				reset:true, 
				stopHead: false,
				count: 0, 
				idle:"mifly169", 
				uid:"mifly169" 
			});
			animationSlices.push({
				animationName: evt.detail.model.animations[0].name,
				name: evt.detail.model.animations[0].name,
				endTime: evt.detail.model.animations[0].duration ,
				startTime: 0,
				uid:"mifly169"
			});
			evt.detail.model.animationSlices = animationSlices;


		} );


		if (document.getElementById("Hoonie")){
			Hoonie.setAttribute("animation-mixer" , "clip: Take 001");
			Hoonie.addEventListener('model-loaded', function (evt){

				let objj = evt.detail.model;
				objj.traverse(node => {
					if (node.isMesh) {
						node.material = new THREE.MeshBasicMaterial({color: new THREE.Color(1,1,1), name: node.name, skinning: node.material.skinning, map: node.material.map});
						if (node.material.map){
							node.material.map.encoding = THREE.GammaEncoding;
							node.material.map.needsUpdate = true;
						}
						node.material.needsUpdate = true;
					}
				});

				let animationSlices = [];
				animationSlices.push({ 
					changed:false, 
					loop:true, 
					reset:true, 
					stopHead: false,
					count: 0, 
					idle:"mifly168", 
					uid:"mifly168" 
				});
				animationSlices.push({
					animationName: evt.detail.model.animations[0].name,
					name: evt.detail.model.animations[0].name,
					endTime: evt.detail.model.animations[0].duration ,
					startTime: 0,
					uid:"mifly168"
				});
				evt.detail.model.animationSlices = animationSlices;
			} );
		}

		function isMobile() {
			return (/Android/i.test(navigator.userAgent) || /iPhone|iPad|iPod/i.test(navigator.userAgent) || navigator.maxTouchPoints > 1 );
		};
		aCamera.addEventListener('loaded', function(evt) { 
			// if (window.navigator.userAgent.toLowerCase().indexOf("mobile") < 0){
			if ( !isMobile() ){
				console.log(" PC, remove look wasd control ");
				aCamera.removeAttribute("look-controls");
				aCamera.removeAttribute("wasd-controls");
			}else{
				// pivotGun.setAttribute("visible", "false");
			}
		});

		//// 設定場景功能，分為 
		//// 1. 按住滑鼠/觸控 來拖拉物件，不可拖拉出特定圓圈範圍。
		//// 2. 放開滑鼠/觸控 來拋射物件，依照移動參數來設定拋射參數。
		//// 3. 設定拋射物件的後續狀況。
		////

		let aScene = document.getElementById("aScene");
		let aRig =  document.getElementById("rig"); //// 原始位置為 (0, 1.6, 0)
		let aSphere =  document.getElementById("aSphere"); //// 原始位置為 (0, 1, -1)
		let aRobot = document.getElementById("aRobot");
		let scoreText = document.getElementById("scoreText")
		let ballAmountText = document.getElementById("ballAmount")
		let aSphereOriginPosition = aSphere.object3D.position.clone();
		aSphere.addEventListener("loaded" , function(evt){
			aSphereOriginPosition = aSphere.object3D.position.clone();
			console.log("aSphereOriginPosition = " , aSphereOriginPosition );
		});
		
		// let ball = document.getElementById("ball");

		let preMouse = new THREE.Vector2();
		let mouse = new THREE.Vector2();
		let mouseStart = new THREE.Vector2();
		let mouseEnd = new THREE.Vector2();
		let pdiff = new THREE.Vector2();
		let raycaster = new THREE.Raycaster();

		let touchMoveTime = Date.now();
		//// 預設原始固定長度為 3 的array 來紀錄滑鼠或觸碰的y值，
		let preMouses = [[0,-2],[0,-2],[0,-2],[0,-2]];
		
		//// 機器人物件遭遇碰撞後的反應，切換動畫。
		// aRobot.addEventListener('collide', function(e){
		// 	console.log('Player has collided with body #', e.detail.target.el.object3D );
		// 	aRobot.setAttribute("animation-mixer" , "clip: Death");
		// 	setTimeout(function(){
		// 		aRobot.setAttribute("animation-mixer" , "clip: Walking");
		// 	}, 1000);
		// });
		let boardTable = [0,0,0,0,0,0,0,0,0,0];
		let ballAmount = 3;
		let score = 0;

		can1.addEventListener('collide', function(e){
			// console.log(e.detail.contact )
			if (e.detail.contact.bj.el.id == "can1"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[0]==0){
					boardTable[0] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can2.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can2"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[1]==0){
					boardTable[1] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can3.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can3"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[2]==0){
					boardTable[2] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can4.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can4"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[3]==0){
					boardTable[3] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can5.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can5"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[4]==0){
					boardTable[4] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can6.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can6"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[5]==0){
					boardTable[5] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can7.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can7"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[6]==0){
					boardTable[6] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can8.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can8"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[7]==0){
					boardTable[7] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can9.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can9"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[8]==0){
					boardTable[8] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		can10.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can10"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[9]==0){
					boardTable[9] = 1;
					score += 1
					scoreText.innerText = "目前擊中: "+score.toString() + "罐";
				}
			}
		});

		function gameEnd(){

			let currectDate = new Date();
			let y = currectDate.getYear();
			let m = currectDate.getMonth() + 1;
			let d = currectDate.getDate()  + 0;
			if (y== 120 && m == 12 && d < 28){
				//// do nothing
			}else {
				return;//// 不顯示結束頁面也不與後端溝通
			}

			if (scoreCheckPageDiv.style.display == "block"){
				console.log("gameEnd: already show scoreCheckPageDiv");
				return;
			}

			fraction.style.display = "none";
			scoreCheckPageDiv.style.display = "block";

			scoreCheckPageDiv.style.overflow = "auto";

			let userID;
			if ( !localStorage.getItem('userID') || !localStorage.getItem('vendor') ){
				userID = "test1@google";
			}else{
				userID = localStorage.getItem('userID')+"@"+localStorage.getItem('vendor');
			}

			// let coins = Math.ceil(score/3);
			let coins = score > 0 ? Math.ceil(score/3) : 1;
			if (coins > 3){
				coins = 3;
			}
			coins *= 3;

			let serverUrl = "https://7leyf90jbd.execute-api.ap-northeast-1.amazonaws.com/prod/yongkangMongoAccess";
			let	postData = {
				ID:  userID, 
				coins: coins,
				gameType: "canKnockdown",
				request: 'play',
				requestItem: ''
			};
			fetch( serverUrl , {
				method: 'POST', 
				headers: { 'Content-Type': 'application/json'},
				body: JSON.stringify(postData)
			} ).then(function(response) {
				return response.json();
			}).then(function(isPlayed) {
				console.log("canKnockdown.html, play isPlayed " , isPlayed );

			
				postData = {
					ID:  userID, 
					request: 'get',
					requestItem: 'userCoins'
				};
				fetch( serverUrl , {
					method: 'POST', 
					headers: { 'Content-Type': 'application/json'},
					body: JSON.stringify(postData)
				} ).then(function(response) {
					return response.json();
				}).then(function(userCoins) {

					let userCurrentCounts = Number(userCoins[0].currentCoins);

					currentCoinsAmountText.innerHTML = userCurrentCounts + " 枚";
					if ( isPlayed[0] == true ){
						previousCoinsAmountText.innerHTML = (userCurrentCounts - coins) + " 枚";
						getCoinsAmountText.innerHTML = coins + " 枚";
						if (score == 0){
							playResultText.innerHTML = "恭喜你！擊倒" + score + " 罐，獲得" + coins + "個永康幣";
						}else{
							playResultText.innerHTML = "恭喜你！擊倒" + score + " 罐，獲得" + coins + "個永康幣";
						}
						
					}
					else{
						previousCoinsAmountText.innerHTML = (userCurrentCounts)+ " 枚";
						getCoinsAmountText.innerHTML = "0 枚";
						if (score == 0){
							playResultText.innerHTML = "Sorry! 一個都沒有擊倒，今日已經遊玩過了，無法獲得永康幣";
						}else{
							playResultText.innerHTML = "恭喜你！擊倒 " + score + " 罐，今日已經遊玩過了，無法獲得永康幣";
						}
					}
			
				});

			});

			//// 點擊『去兌換』
			prizeListDiv.onclick = function(){
				location.href = "/prize-list/index.html";
			}

			//// 點擊『排行榜』
			leaderBdDiv.onclick = function(){
				postData = {
					ID:  userID, 
					request: 'get',
					requestItem: 'coinLeaderboard'
				};
				fetch( serverUrl , {
					method: 'POST', 
					headers: { 'Content-Type': 'application/json'},
					body: JSON.stringify(postData)
				} ).then(function(response) {
					return response.json();
				}).then(function(leaderList) {


					leaderModalDiv.style.display = 'block';

					let leaderModalTable = document.getElementById("leaderModalTable");
					leaderModalTable.innerHTML = "";

					leaderList.forEach((currentValue, index) => {
						
						let row = document.createElement("div");
						row.className = "rankRow";

						let numeralText = document.createElement("p");
						numeralText.className = "centerP";
						numeralText.style.color = "#F47165";
						numeralText.innerHTML = index+1;

						let nameInfoTextDiv = document.createElement("div");
						let nameInfoNumberDiv = document.createElement("div");

						nameInfoNumberDiv.className = "nameInfoNumberDiv";
						nameInfoNumberDiv.style.overflow = "hidden";
						nameInfoTextDiv.className = "nameInfoTextDiv";

						let nameInfoText = document.createElement("p");
						nameInfoText.className = "centerP";
						nameInfoText.style.color = "#F47165";

						let nameInfoNumber = document.createElement("p");
						nameInfoNumber.className = "centerP";
						nameInfoNumber.style.color = "#F47165";
						nameInfoNumber.innerHTML = currentValue.couponExchanged;;
						nameInfoNumberDiv.appendChild(nameInfoNumber);

						let userName;
						if (currentValue.name == "" || currentValue.name == null ){
						userName = "user";
						}else{
						userName = currentValue.name;
						}
						nameInfoText.innerHTML = userName;
						nameInfoTextDiv.appendChild(nameInfoText);


						let numeralDiv = document.createElement("div");
						let nameInfoDiv = document.createElement("div");
						numeralDiv.className = "rankNumeralDiv";
						nameInfoDiv.className = "rankNameInfoDiv";
						nameInfoDiv.style.overflow = "hidden";

						let numeral = new Image();
						numeral.src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/ranked/numeral.png";
						numeral.className = "rankNumeralImg";

						let nameInfo = new Image();
						nameInfo.src = "https://yongkangfile.s3-ap-northeast-1.amazonaws.com/images/ui/window/ranked/name.png"
						nameInfo.className = "rankNameInfoImg";

						numeralDiv.appendChild(numeral);
						numeralDiv.appendChild(numeralText);
						nameInfoDiv.appendChild(nameInfo);
						nameInfoDiv.appendChild(nameInfoTextDiv);
						nameInfoDiv.appendChild(nameInfoNumberDiv);
						
						row.appendChild(numeralDiv);
						row.appendChild(nameInfoDiv);
						leaderModalTable.appendChild(row);

					});			



				});

			}

		}

		//// 開啟一個固定時間來檢查分數的機制，
		let intervalId = setInterval(checkScore, 1000); 
		function checkScore(){
			if (score == 10){
				clearInterval(intervalId);
				setTimeout( gameEnd , 2000)
				
			}
		}

		document.body.addEventListener("mouseup", clearTouchState, false);
		document.body.addEventListener("touchend", clearTouchState, false);

		aScene.canvas.addEventListener("touchstart", vrSceneTouchStart, false);
		aScene.canvas.addEventListener("mousedown", vrSceneTouchStart, false);

		aScene.canvas.addEventListener("mousemove", vrSceneTouchMove, false);
		aScene.canvas.addEventListener("touchmove", vrSceneTouchMove, false);

		aScene.canvas.addEventListener("mouseup", vrSceneTouchEnd, false);
		aScene.canvas.addEventListener("touchend", vrSceneTouchEnd, false);

		let touchState = 0; //// 0: 滑鼠沒有按下/手指沒有點擊, 1: 滑鼠已經按下/手指正在點擊, 2: 滑鼠剛剛放開/手指剛剛離開，注意 0 - 2 狀態轉移
		function vrSceneTouchStart(event){

			document.getElementById("bgAudio").play();
			if (touchState == 0){
				touchState = 1;
				event.preventDefault();

				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mousedown": ////// 20190709 Fei: add this event type for PC mouse
						mouseStart.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseStart.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;
					case "touchstart": ////// 20190709 Fei: add this event type for cellphone
						// console.log("endEvent: touchend: event.touches  = ", event.changedTouches[0].clientX, event.changedTouches[0].clientY );
						mouseStart.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseStart.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousedown/touchstart, return ");
						return ;

				}

				//// 點擊即把球物件移動到滑鼠/觸碰位置 
				// let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs(aRig.object3D.position.z - aSphereOriginPosition.z) * 1 ;
				let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs( aSphere.object3D.position.z ) * 1 ;
				let planeWidth = planeHeight * aCamera.object3DMap.camera.aspect;
				aSphere.object3D.position.x = mouseStart.x * planeWidth ;
				// aSphere.object3D.position.y = aRig.object3D.position.y + mouseStart.y * planeHeight ;
				aSphere.object3D.position.y = aRig.object3D.position.y + mouseStart.y * planeHeight + aSphereOriginPosition.y ;

			}
			
		}
	
		function vrSceneTouchMove(event){
			if (touchState == 1){
				event.preventDefault();

				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mousemove": ////// 20190709 Fei: add this event type for PC mouse
						mouse.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouse.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;

						preMouses.push([mouse.x, mouse.y]);
						preMouses.shift();
						
						break;
					case "touchmove": ////// 20190709 Fei: add this event type for cellphone
						mouse.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouse.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;

						preMouses.push([mouse.x, mouse.y]);
						preMouses.shift();
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousemove/touchmove, return ");
						return ;

				}

				//// 球物件的起始位置為 (0, 1, -1)
				pdiff = mouse.clone().sub(mouseStart) ;
				//// 計算出應該要呈現的位置，從『原始球的位置的z軸數值』與『當前相機垂直fov角度的一半』可以算出『與原始球的xy平面的高度』
				//// 再使用『畫面比例所造成的相機比例』算出『與原始球的xy平面的寬度』
				//// 因為拖拉移動有正負，所以當滑鼠拖拉『從中心到寬邊最距離』對應於『原始球位置到相機最外緣』
				// let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs(aRig.object3D.position.z - aSphereOriginPosition.z) * 1 ;
				let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs( aSphere.object3D.position.z ) * 1 ;
				let planeWidth = planeHeight * aCamera.object3DMap.camera.aspect;

				
				//// 點擊即把球物件移動到滑鼠/觸碰位置
				aSphere.object3D.position.x = mouse.x * planeWidth ;
				// aSphere.object3D.position.y = aRig.object3D.position.y + mouse.y * planeHeight ;
				aSphere.object3D.position.y = aRig.object3D.position.y + mouse.y * planeHeight + aSphereOriginPosition.y ;

				touchMoveTime = Date.now();
				// console.log("vrSceneTouchMove , pdiff =" , pdiff );

			}
		}
	
		function vrSceneTouchEnd(event){
			if (touchState == 1){
				event.preventDefault();
				event.stopPropagation();


				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mouseup": ////// 20190709 Fei: add this event type for PC mouse
						mouseEnd.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseEnd.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;
					case "touchend": ////// 20190709 Fei: add this event type for cellphone
						// console.log("endEvent: touchend: event.touches  = ", event.changedTouches[0].clientX, event.changedTouches[0].clientY );
						mouseEnd.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseEnd.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousedown/touchstart, return ");
						return ;

				}

				//// 假如使用者『持球』過久，則判定沒有選定方向，重來
				if ( Date.now() - touchMoveTime > 200){
					console.log(" ********** touchMove stay too long " , preMouses  );
					clearTouchState();
					return;
				}

				//// 假如使用者『不是往上投擲』，重來
				if (preMouses[0][1]+0.02 < preMouses[1][1] && preMouses[1][1]+0.02 < preMouses[2][1] && preMouses[2][1]+0.02 < preMouses[3][1] ){
					console.log(" ********** direction y up = " , preMouses );
					
				}else if (preMouses[0][1] > preMouses[1][1]+0.02 && preMouses[1][1] > preMouses[2][1]+0.02 && preMouses[2][1] > preMouses[3][1]+0.02 ){
					console.log(" ********** direction y down " , preMouses );
					clearTouchState();
					return;
				}else if ( Math.abs(preMouses[0][1]-preMouses[1][1]) < 0.02 && Math.abs(preMouses[1][1]-preMouses[2][1]) < 0.02 &&
						   Math.abs(preMouses[2][1]-preMouses[3][1]) < 0.02 ){
					console.log(" ********** direction y not up not down small " , preMouses );
					clearTouchState();
					return;
				}else{
					console.log(" ********** direction y not up not down big" , preMouses );
				}
				
				//// 投擲預設的球物件
				let dragX, dragY, dragLength;
				//// 在手指於螢幕上滑動的時候會紀錄下最多四個位置。每次手指離開螢幕則 list 會歸零回 x = 0, y = -2
				//// 計算使用者手指的軌跡方式如下，先找出『有效的滑動位置』（y方向大於 -2 者才能算）。
				//// 假如『有效的滑動位置』數量超過一，則計算起始與終點的距離，再除上『有效數量』
				let effectiveMouses = []
				for( let i = 0, len = preMouses.length; i < len; i++ ){
					if (preMouses[i][1] > -2){
						effectiveMouses.push(preMouses[i]) ;
					}
				}
				if (effectiveMouses.length > 1){
					dragX = effectiveMouses[ effectiveMouses.length - 1 ][0] - effectiveMouses[0][0];
					dragY = effectiveMouses[ effectiveMouses.length - 1 ][1] - effectiveMouses[0][1];
					dragLength = Math.pow( dragX*dragX+dragY*dragY , 0.5) /effectiveMouses.length  ;
					console.log(" _effectiveMouses > 1: " , effectiveMouses.length , effectiveMouses , dragLength );

				}else{
					console.log(" _effectiveMouses: length <= 1 call clearTouchState");
					clearTouchState();
					return;
				}

				touchState = 2;
				
				let velocity = new THREE.Vector3( dragX , dragY , -dragY*1.3 ).normalize().multiplyScalar(dragLength*60);
				let v2 = velocity.clone().applyEuler( aCamera.object3D.rotation ); //// 改版後
				velocity = v2.clone();


				aSphere.setAttribute( "dynamic-body", "mass: 1000; shape:sphere;" );

				aSphere.body.velocity.set( velocity.x, velocity.y, velocity.z );

				ballAmount -= 1;
				ballAmountText.innerText = "球數: "+ballAmount.toString();
				// resetSphere(2000);


				if (ballAmount == 0){
					setTimeout( gameEnd, 6000);
				}else{
					setTimeout( function(){
						resetSphere(1);
						//// 依序隱藏『籃子』裡面的球，目前此功能不開啟
						// if (ballAmount == 2){
						// 	basket.object3D.children[0].children[0].children[3].visible = false;
						// }else if (ballAmount == 1){
						// 	basket.object3D.children[0].children[0].children[4].visible = false;
						// }else if (ballAmount == 0){
						// 	basket.object3D.children[0].children[0].children[5].visible = false;
						// }
					}, 3000);

				}

				
				preMouses = [[0,-2],[0,-2],[0,-2],[0,-2]];

				// aSphere.object3D.position.x = 0 ;
				// aSphere.object3D.position.y = 1 ;
			}

		}

		function clearTouchState(event){
			if (touchState == 1){
				touchState = 0;
				resetSphere(10);
				console.log("clearTouchState" );
			}
		}

		function resetSphere(time){
			let delay = time? time: 3000;
			setTimeout(function(){
				//// 移除物理性，並且重設位置
				aSphere.removeAttribute( "dynamic-body");
				aSphere.object3D.position.copy(aSphereOriginPosition);
				aSphere.object3D.rotation.set(0, 0, 0);

				touchState = 0;
				console.log("resetSphere set 0" );
			}, delay);
		}

		let self = {};
		let videoScene = new THREE.Scene();
		self.videoScene = videoScene;
		self.GLRenderer = aScene.renderer;
		aScene.renderer.autoClear = false;
		self.aScene = aScene;


		// renderTick();
		startCamera( function(){
			renderTick();	

			setTimeout(function(){
				// renderTick();
				//// 即使沒開相機，也能玩
				if (self.video){
					self.video.play();
				}
			} , 1000);

			// loadPage.style.display = "none";
			isRenderTick = true;
		});


		function renderTick(){
			
			if (self.videoCamera){
				self.GLRenderer.render( self.videoScene, self.videoCamera);
			}	
			self.GLRenderer.clearDepth();
			if (self.aScene.object3D && self.aScene.camera){
				self.GLRenderer.render( self.aScene.object3D, self.aScene.camera );
			}

			// console.log("renderTick");
			requestAnimationFrame(renderTick); // dont use it, because of the haning problem
		};



		function startCamera( callback ){

			let video = document.createElement('video');
			let configuration = { facing: "environment" };
			let texture = new THREE.VideoTexture(video);
			texture.minFilter = THREE.LinearFilter;
			texture.flipY = false;
			texture.format = THREE.RGBFormat; // THREE.RGBAFormat



			console.log(" _startCamera dcwh= " , document.documentElement.clientWidth , document.documentElement.clientHeight );

			if ( navigator.mediaDevices  ) {
				let onError = function(err) { 
					console.error(" _startCamera error:", err); 
					//// 即使沒開相機，也能玩
					aScene.setAttribute("background" , "color: #FFF3D8");
					if (callback){
						callback();
					}
				};

				let videoSuccess = function(stream){
					window.videoStream = stream;
					video.srcObject = stream;
					video.playsInline = true;
					video.onloadedmetadata = function() {
						function tick_video(){
							if (video.videoWidth > 200 || video.videoHeight > 200){
								console.log("XRFunc.js: tick_video play video[w, h]=", video.videoWidth, video.videoHeight );
								//// 將video 物件記錄下來，在後面等 renderer 開始工作後再啟動
								self.video  = video;
								// video.play();

								//////// set the div size depend on video
								let videoWidth, videoHeight;
								let aDiv = document.getElementById("aDiv");
								let w, h;
								if ( document.documentElement.clientWidth/document.documentElement.clientHeight > video.videoWidth/video.videoHeight ){
									
									w = window.innerWidth  ;
									h = (window.innerWidth/video.videoWidth)* video.videoHeight;

									console.log(" 1 set div size = ", innerWidth, innerHeight, w ,h, videoWidth, videoHeight );
								}else{
									
									w = (window.innerHeight/video.videoHeight) * video.videoWidth ;
									h = window.innerHeight;
									
									console.log(" 2 set div size = ", innerWidth, innerHeight, w ,h, videoWidth, videoHeight );
								}

								//// full fill, left nothing blank
								aDiv.style.width  = w + "px" ;
								aDiv.style.height = h + "px" ;
								//// align the div and body
								aDiv.style.left = ( innerWidth - w )/2 + "px" ;
								aDiv.style.top  = ( innerHeight - h )/2 + "px" ;
								

								aScene.resize(); ////// it must call after renderer resize

								////// setup the camera for 2D scene( 20200314 useless )
								// let camera2D = new THREE.OrthographicCamera( -w/2, w/2, -h/2, h/2, -10, 20000);
								//// 20201110 fei: 設定相機跟背景的時候直接使用『實體相機畫面尺寸』作為設定，手機端基本是[480, 640] 電腦端基本是[640, 480]
								videoWidth = texture.image.videoWidth,  videoHeight = texture.image.videoHeight;

								
								////// setup the camera for background video
								let videoCamera = new THREE.OrthographicCamera( -videoWidth/2, videoWidth/2, -videoHeight/2, videoHeight/2, -10, 20000);
								self.videoCamera = videoCamera;
								
								////// setup videoPlane
								let videoPlane = new THREE.Mesh(
									new THREE.PlaneBufferGeometry( videoWidth , videoHeight ),
									new THREE.MeshBasicMaterial( { map:texture, side: THREE.DoubleSide } ) ,
								);
								// videoPlane.material.depthTest = false;
								// videoPlane.material.depthWrite = false;
								videoPlane.position.set(0, 0, -1 );
								self.videoScene.add( videoPlane );
								
								if ( callback ) { callback(); }

							}else{
								console.log("tick_video else video[w, h]=", video.videoWidth, video.videoHeight );
								setTimeout(tick_video, 100);
							}
						}

						if ( self.videoCamera ){
							console.log("_startCamera: videoCamera exist, donothing ");
						}else{
							console.log("_startCamera: videoCamera not exist, start video ");
							tick_video();
						}
						
					}
					
				}

				
				navigator.mediaDevices.enumerateDevices().then(function(devices) {
					let useDeviceID = false;
					let cameraID, facingString, video_constraints;
					devices = devices.filter(function(devices) { return devices.kind === 'videoinput'; });
					if ( configuration.facing == "environment" ){facingString = "back";} 
					else if (configuration.facing == "user" ){facingString = "front";} 
					else{facingString = "back";}
					for (let i in devices){
						if( devices[i].label.toLowerCase().search( facingString ) != -1  ){ // front back
							cameraID = devices[i].deviceId;
							useDeviceID = true;
						}
					}
					if (useDeviceID){ // PC, android chrome/FireFox, use the specific id by labels.
						console.log("useDeviceID true, cameraID=", cameraID );
						video_constraints = {
							video: {
								width: { min: 320, ideal: 640, max: 1280 },
								height: { min: 240, ideal: 480, max: 800 }, 
								frameRate: { min:15, ideal: 30, max: 60 },
								deviceId: {'exact':cameraID }
							}
						};
					}else{
						let facing;
						if ( configuration.facing ){ //// usually iOS safari and QQ, use "user"/"environment" to start
							facing = configuration.facing;
							console.log("configuration.facing do exist: set facing = ", facing );
							video_constraints = {
								video: {
									width: { min: 320, ideal: 640, max: 1280 },
									height: { min: 240, ideal: 480, max: 800 }, 
									frameRate: { min:15, ideal: 30, max: 60 },
									facingMode: facing
								}
							};
						}else{
							console.log("configuration.facing dosent exist: set facing = environment" );
							video_constraints = {
								video: {
									width: { min: 320, ideal: 640, max: 1280 },
									height: { min: 240, ideal: 480, max: 800 }, 
									frameRate: { min:15, ideal: 30, max: 60 },
									facingMode: 'environment'
								}
							};
						}
					}

					navigator.mediaDevices.getUserMedia( video_constraints ).then(videoSuccess, onError); // successCallback
				
				});

			}else{
				if (callback){
					callback();
				}
			}

			console.log(" +++++++ ");
		}





	</script>

</body>
</html>

