<!doctype html>
<html >
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>upload sky</title>
	<style>

		html, body {
			background: #fff;
			color: #000;
			font-family: sans-serif;
			text-align: center;
			width:100%;
			height:100%;
			margin: 0;
		}

		#myEmbeddedScene{
			/* margin: 20px 10px; */
			/* width:800px; */
			/* height:600px; */
			width:100%;
			height:100%;
		}

		@media screen and (min-width: 300px) and (max-width: 700px) {
			#myEmbeddedScene{
				/* margin: 20px 10px; */
				/* width:400px; */
				/* height:300px; */
				width:100%;
				height:100%;
			}
		}

		#blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1;
        }

		#blocker_score {
			display: none;
			position: absolute;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.7);
			z-index: 1;
		}

		.instructions {
			width: 100%;
			height: 100%;

			display: -webkit-box;
			display: -moz-box;
			display: box;

			-webkit-box-orient: horizontal;
			-moz-box-orient: horizontal;
			box-orient: horizontal;

			-webkit-box-pack: center;
			-moz-box-pack: center;
			box-pack: center;

			-webkit-box-align: center;
			-moz-box-align: center;
			box-align: center;

			color: #ffffff;
			text-align: center;
			font-family: Arial;
			font-size: 24px;
			line-height: 34px;

			cursor: pointer;
		}

		#score{
			position: absolute;
			z-index: 2;
			left :5%;
			bottom: 2%;		
			font-family: Arial;
			font-size: 20px;
			/* color: #FFFFFF; */
		}

		#ballAmount{
			position: absolute;
			z-index: 2;
			right :5%;
			bottom: 2%;		
			font-family: Arial;
			font-size: 20px;
			/* color: #FF0000; */
		}

	</style>


</head>
<body>
	
	<div id = "closeIframe" style="position: absolute;z-index: 2;font-size: 15pt; color:rgba(0,0,0,0.5); cursor:pointer;"	>
		返回主頁面
	</div>

	<div id="blocker">
        <div class="instructions" id = "blocker_info">
            <span style="font-size:36px">Click to play</span>
            <br /><br />
            滑鼠/手指滑動螢幕來丟球<br/>
            總共3球，看看你能夠得到幾分吧<br/>
        </div>
    </div>
    <div id="blocker_score">
        <div class="instructions" >
            <span style="font-size:36px">Click to play again</span>
            <br /><br />
            <span style="font-size:36px; color:#00c99c" id = "score_info"> </span>
            <br/>
            點擊畫面前往兌換區<br/>
        </div>
	</div>
	<div id="score">
		分數: 0
	</div>

	<div id="ballAmount">
		球數: 3
	</div>


	<script src="js/vconsole.min.js"></script>
	<script>
		if ( window.navigator.userAgent.toLowerCase().indexOf("mobile") >= 0 && window.navigator.userAgent.toLowerCase().indexOf("chrome") < 0 ){
			var vConsole = new VConsole();
			console.log("The system is mobile: ", window.navigator.userAgent.toLowerCase() );
		}else{
			console.log("The system is PC: ", window.navigator.userAgent.toLowerCase() );
		}

		window.requestDeviceMotionPermission = function (){
            // console.log("makarVR.html: requestDeviceMotionPermission  " );
            if (typeof(DeviceMotionEvent) !== 'undefined' && typeof(DeviceMotionEvent.requestPermission) === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    console.log("makarVR.html: requestPermission response =", response );
                    // alert('Orientation tracking '+ response);
                    if (response == 'granted') {
                        window.addEventListener('devicemotion', (e) => {
                            // but.style.visibility='hidden';
                        })
                    }
                }).catch(console.error)
            }else {
                // alert('DeviceMotionEvent is not defined');
                // console.log("makarVR.html: requestPermission: DeviceMotionEvent is not defined " );
            }
		}

		document.body.onclick = function(){
			requestDeviceMotionPermission();
		}

		document.getElementById("closeIframe").addEventListener('click', function(){
			// if (parent){
			// 	parent.aUI.closeGameIframe();
			// }
			location.replace("/");
		});
		
	</script>

	<script src="js/aframe-v1.0.4.js"></script>
	<script src="js/aframe-extras.js"></script>

	<script src="js/aframe-physics-system.js"></script>
	<script src="js/aframe-physics-extras.min.js"></script>

	<!-- <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script> -->

	<div id = "myEmbeddedScene"  >
		<a-scene id = "aScene" embedded="" vr-mode-ui="enabled: false" 
		device-orientation-permission-ui="enabled: true"  background="color: #ECECEC" shadow="type: pcfsoft"
		physics="debug: false; friction: 0.05;" >
			<a-assets id = "aAssets">

				
				<a-asset-item id="basketball" src="model/basketball.glb"></a-asset-item>

			</a-assets>

			<a-entity id="rig" position="0 0.8 1.0" rotation="0 0 0">
				<!-- <a-entity id="aCamera" camera  look-controls wasd-controls></a-entity> -->
				<a-entity id="aCamera" camera="fov:80; zoom:1" ></a-entity>
			</a-entity>
			
			<!-- 籃球本身 -->
			<a-entity visible = "true" id = "aSphere" position="0 0.1 -1.0" rotation="0 0 0" scale=" 0.5 0.5 0.5 " gltf-model="#basketball" ></a-entity>

			
			<!-- 丟沙包 -->
			
			<!-- 罐子塔 -->
			<!-- 最下層 -->
			
			<a-cylinder color="crimson" height="0.75" radius="0.2" position="-0.66 0.47 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can7" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<a-cylinder color="crimson" height="0.75" radius="0.2" position="-0.22 0.47 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can8" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<a-cylinder color="crimson" height="0.75" radius="0.2" position="0.22 0.47 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can9" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<a-cylinder color="crimson" height="0.75" radius="0.2" position="0.66 0.47 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can10" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<!-- 第三層 -->
			

			<a-cylinder color="crimson" height="0.75" radius="0.2" position="-0.44 1.2195 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can4" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<a-cylinder color="crimson" height="0.75" radius="0.2" position="0 1.2195 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can5" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<a-cylinder color="crimson" height="0.75" radius="0.2" position="0.44 1.2195 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can6" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<!-- 第二層 -->
			

			
			<a-cylinder color="crimson" height="0.75" radius="0.2" position="-0.22 1.969 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500"  id="can2" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<a-cylinder color="crimson" height="0.75" radius="0.2" position="0.22 1.969 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can3" sleepy="allowSleep: true; speedLimit:1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

			<!-- 最上層 -->
			
			<a-cylinder color="crimson" height="0.75" radius="0.2" position="0 2.72 -3" rotation="0 0 0" scale=" 1 1 1 " dynamic-body="mass:500" id="can1" sleepy="allowSleep: true; speedLimit:1; inearDamping: 0.01; angularDamping: 0.01"></a-cylinder>


			<!-- 丟沙包 -->

			<!-- <a-plane id="underplane" position="0 0 -3" rotation="-90 0 0" width="2" height="0.2" color="#4D3900" opacity="1" shadow="receive: true" static-body></a-plane> -->

			<a-plane id="underplane1" position="0 -3 0" rotation="-90 0 0" width="50" height="50" color="#7BC8A4" opacity="0.5" shadow="receive: true" static-body></a-plane>


			<a-box id="underplane2" position="0 0 -3" rotation="-90 0 0" width="2" height="0.2" depth="0.2"  color="#4D3900" opacity="1" shadow="receive: true" static-body></a-box>


			<a-sky id = "aSky" color="#ECECEC"></a-sky>
			<a-entity light="type: ambient; color: #FFFFFF"></a-entity>
			<a-entity light="type: directional; color: #FFFFFF; intensity: 0.9;
								   castShadow: true; 
								   shadowCameraVisible: false;
								   shadowBias:-0.0005; 
								   shadowCameraTop:10; shadowCameraBottom:-10; 
								   shadowCameraRight:10; shadowCameraLeft:-10; 
								   shadowMapHeight:3072; shadowMapWidth:3072; 
								   shadowCameraFar: 500; shadowCameraNear: 0.5;" 
			          position="0 0 1"></a-entity>
			<!-- <a-entity camera="active: true" look-controls wasd-controls position="0 1.6 0"></a-entity> -->
		</a-scene>

	</div>	

	<script>
		

		blocker.addEventListener("click", function(){
			blocker.style.display = "none";
		});

		//// 設定場景功能，分為 
		//// 1. 按住滑鼠/觸控 來拖拉物件，不可拖拉出特定圓圈範圍。
		//// 2. 放開滑鼠/觸控 來拋射物件，依照移動參數來設定拋射參數。
		//// 3. 設定拋射物件的後續狀況。
		////

		let aScene = document.getElementById("aScene");
		let aRig =  document.getElementById("rig"); //// 原始位置為 (0, 1.6, 0)
		let aSphere =  document.getElementById("aSphere"); //// 原始位置為 (0, 1, -1)
		let aRobot = document.getElementById("aRobot");
		let scoreText = document.getElementById("score")
		let ballAmountText = document.getElementById("ballAmount")
		let aSphereOriginPosition = aSphere.object3D.position.clone();
		aSphere.addEventListener("loaded" , function(evt){
			aSphereOriginPosition = aSphere.object3D.position.clone();
			console.log("aSphereOriginPosition = " , aSphereOriginPosition );
		});
		
		// let ball = document.getElementById("ball");

		let preMouse = new THREE.Vector2();
		let mouse = new THREE.Vector2();
		let mouseStart = new THREE.Vector2();
		let mouseEnd = new THREE.Vector2();
		let pdiff = new THREE.Vector2();
		let raycaster = new THREE.Raycaster();

		let touchMoveTime = Date.now();
		//// 預設原始固定長度為 3 的array 來紀錄滑鼠或觸碰的y值，
		let preMouses = [[0,0],[0,0],[0,0],[0,0]];
		
		//// 機器人物件遭遇碰撞後的反應，切換動畫。
		// aRobot.addEventListener('collide', function(e){
		// 	console.log('Player has collided with body #', e.detail.target.el.object3D );
		// 	aRobot.setAttribute("animation-mixer" , "clip: Death");
		// 	setTimeout(function(){
		// 		aRobot.setAttribute("animation-mixer" , "clip: Walking");
		// 	}, 1000);
		// });
		let boardTable = [0,0,0,0,0,0,0,0,0,0];
		let ballAmount = 3;
		let score = 0;

		can1.addEventListener('collide', function(e){
			// console.log(e.detail.contact )
			if (e.detail.contact.bj.el.id == "can1"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[0]==0){
					boardTable[0] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can2.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can2"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[1]==0){
					boardTable[1] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can3.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can3"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[2]==0){
					boardTable[2] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can4.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can4"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[3]==0){
					boardTable[3] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can5.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can5"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[4]==0){
					boardTable[4] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can6.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can6"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[5]==0){
					boardTable[5] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can7.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can7"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[6]==0){
					boardTable[6] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can8.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can8"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[7]==0){
					boardTable[7] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can9.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can9"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[8]==0){
					boardTable[8] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});

		can10.addEventListener('collide', function(e){
			if (e.detail.contact.bj.el.id == "can10"){
				// console.log(e.detail.contact.bi.el.object3D.position )
				pos = e.detail.contact.bj.el.object3D.position
				if(pos.y < 0 && boardTable[9]==0){
					boardTable[9] = 1;
					score += 1
					scoreText.innerText = "分數: "+score.toString();
				}
			}
		});


		

		document.body.addEventListener("mouseup", clearTouchState, false);
		document.body.addEventListener("touchend", clearTouchState, false);

		aScene.canvas.addEventListener("touchstart", vrSceneTouchStart, false);
		aScene.canvas.addEventListener("mousedown", vrSceneTouchStart, false);

		aScene.canvas.addEventListener("mousemove", vrSceneTouchMove, false);
		aScene.canvas.addEventListener("touchmove", vrSceneTouchMove, false);

		aScene.canvas.addEventListener("mouseup", vrSceneTouchEnd, false);
		aScene.canvas.addEventListener("touchend", vrSceneTouchEnd, false);

		let touchState = 0; //// 0: 滑鼠沒有按下/手指沒有點擊, 1: 滑鼠已經按下/手指正在點擊, 2: 滑鼠剛剛放開/手指剛剛離開，注意 0 - 2 狀態轉移
		function vrSceneTouchStart(event){

			if (touchState == 0){
				touchState = 1;
				event.preventDefault();

				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mousedown": ////// 20190709 Fei: add this event type for PC mouse
						mouseStart.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseStart.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;
					case "touchstart": ////// 20190709 Fei: add this event type for cellphone
						// console.log("endEvent: touchend: event.touches  = ", event.changedTouches[0].clientX, event.changedTouches[0].clientY );
						mouseStart.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseStart.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousedown/touchstart, return ");
						return ;

				}

				//// 點擊即把球物件移動到滑鼠/觸碰位置 
				let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs(aRig.object3D.position.z - aSphereOriginPosition.z) * 1 ;
				let planeWidth = planeHeight * aCamera.object3DMap.camera.aspect;
				aSphere.object3D.position.x = mouseStart.x * planeWidth ;
				aSphere.object3D.position.y = aRig.object3D.position.y + mouseStart.y * planeHeight ;

			}
			
		}
	
		function vrSceneTouchMove(event){
			if (touchState == 1){
				event.preventDefault();

				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mousemove": ////// 20190709 Fei: add this event type for PC mouse
						mouse.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouse.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;

						preMouses.push([mouse.x, mouse.y]);
						preMouses.shift();
						
						break;
					case "touchmove": ////// 20190709 Fei: add this event type for cellphone
						mouse.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouse.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;

						preMouses.push([mouse.x, mouse.y]);
						preMouses.shift();
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousemove/touchmove, return ");
						return ;

				}

				//// 球物件的起始位置為 (0, 1, -1)
				pdiff = mouse.clone().sub(mouseStart) ;
				//// 計算出應該要呈現的位置，從『原始球的位置的z軸數值』與『當前相機垂直fov角度的一半』可以算出『與原始球的xy平面的高度』
				//// 再使用『畫面比例所造成的相機比例』算出『與原始球的xy平面的寬度』
				//// 因為拖拉移動有正負，所以當滑鼠拖拉『從中心到寬邊最距離』對應於『原始球位置到相機最外緣』
				let planeHeight = Math.tan( aCamera.object3DMap.camera.fov/2/180*Math.PI) * Math.abs(aRig.object3D.position.z - aSphereOriginPosition.z) * 1 ;
				let planeWidth = planeHeight * aCamera.object3DMap.camera.aspect;

				
				//// 點擊即把球物件移動到滑鼠/觸碰位置
				aSphere.object3D.position.x = mouse.x * planeWidth ;
				aSphere.object3D.position.y = aRig.object3D.position.y + mouse.y * planeHeight ;

				touchMoveTime = Date.now();
				// console.log("vrSceneTouchMove , pdiff =" , pdiff );

			}
		}
	
		function vrSceneTouchEnd(event){
			if (touchState == 1){
				event.preventDefault();
				event.stopPropagation();


				let rect = aScene.renderer.domElement.getBoundingClientRect();
				switch ( event.type ) {
					case "mouseup": ////// 20190709 Fei: add this event type for PC mouse
						mouseEnd.x = ( (event.clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseEnd.y = - ( (event.clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;
					case "touchend": ////// 20190709 Fei: add this event type for cellphone
						// console.log("endEvent: touchend: event.touches  = ", event.changedTouches[0].clientX, event.changedTouches[0].clientY );
						mouseEnd.x = ( (event.changedTouches[0].clientX - rect.left) / aScene.renderer.domElement.clientWidth ) * 2 - 1;
						mouseEnd.y = - ( (event.changedTouches[0].clientY - rect.top) / aScene.renderer.domElement.clientHeight ) * 2 + 1;
						break;

					default:
						console.log(" startEvent: event.type=", event.type, " not mousedown/touchstart, return ");
						return ;

				}

				//// 假如使用者『持球』過久，則判定沒有選定方向，重來
				if ( Date.now() - touchMoveTime > 200){
					console.log(" ********** touchMove stay too long "  );
					clearTouchState();
					return;
				}

				//// 假如使用者『不是往上投擲』，重來
				if (preMouses[0][1]+0.001 < preMouses[1][1] && preMouses[1][1]+0.001 < preMouses[2][1] ){
					console.log(" ********** direction y up = " , preMouses );
					
				}else if (preMouses[0][1] > preMouses[1][1]+0.001 && preMouses[1][1] > preMouses[2][1]+0.001 ){
					console.log(" ********** direction y down " , preMouses );
					clearTouchState();
					return;
				}else{
					console.log(" ********** direction y not up not down " , preMouses );
					clearTouchState();
					return;
				}
				

				touchState = 2;
				

				//// 投擲預設的球物件
				raycaster.setFromCamera( mouseEnd, aScene.camera );


				let dragX = preMouses[3][0] - preMouses[0][0];
				let dragY = preMouses[3][1] - preMouses[0][1];
				let dragLength = Math.pow( dragX*dragX+dragY*dragY , 0.5);
				let velocity = new THREE.Vector3( dragX , dragY , -dragY ).normalize().multiplyScalar(dragLength*20);
				

				let vector = raycaster.ray.direction.multiplyScalar(10);
				aSphere.setAttribute( "dynamic-body", "mass: 700" );

				// aSphere.body.velocity.set( vector.x, vector.y, vector.z );
				aSphere.body.velocity.set( velocity.x, velocity.y, velocity.z );

				ballAmount -= 1;
				ballAmountText.innerText = "球數: "+ballAmount.toString();
				// resetSphere(2000);


				function gameEnd(){
					blocker_score.style.display = "block";

					let userID;
					if ( !localStorage.getItem('userID') || !localStorage.getItem('vendor') ){
						userID = "test1@google";
					}else{
						userID = localStorage.getItem('userID')+"@"+localStorage.getItem('vendor');
					}

					let serverUrl = "https://7leyf90jbd.execute-api.ap-northeast-1.amazonaws.com/prod/yongkangMongoAccess";
					let	postData = {
						ID:  userID, 
						coins: Math.ceil(score/3),
						gameType: "canKnockdown",
						request: 'play',
						requestItem: ''
					};
					fetch( serverUrl , {
						method: 'POST', 
						headers: { 'Content-Type': 'application/json'},
						body: JSON.stringify(postData)
					} ).then(function(response) {
						return response.json();
					}).then(function(myJson) {
						console.log("canKnockdown.html, play myJson " , myJson );
						if ( myJson[0] == true ){
							score_info.innerHTML = "恭喜獲得" + score + "分<br>取得" + Math.ceil(score/3) + "枚代幣";
						}else{
							score_info.innerHTML = "恭喜獲得" + score + "分<br>今日已經遊玩過了，無法獲得代幣";
						}
						//// 一秒後可以點擊畫面
						setTimeout(function(){
							blocker_score.style.pointerEvents = "auto";
						}, 2000);

					});

					blocker_score.onclick = function(){
						// location.reload();
						location.replace("/prize-list");
					}
				}

				if(score<10){
					setTimeout(function(){
						if(score==10 || ballAmount == 0){
							gameEnd();
						}
						else{
							resetSphere(1);
						}
						
					}, 3000);
				}
				else{
					setTimeout(function(){
						if(score==10 || ballAmount == 0){
							gameEnd();
						}
						
					}, 5000);
				}
				
				
				console.log("vrSceneTouchEnd set 2 " , pdiff , "\n", preMouses[3][0] - preMouses[0][0] , preMouses[3][1] - preMouses[0][1] );
				preMouses = [[0,0],[0,0],[0,0],[0,0]];

				// aSphere.object3D.position.x = 0 ;
				// aSphere.object3D.position.y = 1 ;
			}

		}

		function clearTouchState(event){
			if (touchState == 1){
				touchState = 0;
				resetSphere(10);
				console.log("clearTouchState" );
			}
		}

		function resetSphere(time){
			let delay = time? time: 3000;
			setTimeout(function(){
				//// 移除物理性，並且重設位置
				aSphere.removeAttribute( "dynamic-body");
				aSphere.object3D.position.copy(aSphereOriginPosition);
				aSphere.object3D.rotation.set(0, 0, 0);

				touchState = 0;
				console.log("resetSphere set 0" );
			}, delay);
		}

		renderTick();
		function renderTick(){
			if (aScene.object3D && aScene.camera){
				aScene.renderer.render( aScene.object3D, aScene.camera );
			}
			// console.log("renderTick");
			requestAnimationFrame(renderTick); // dont use it, because of the haning problem
		};

	</script>

</body>
</html>

